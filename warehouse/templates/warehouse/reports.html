{% extends 'warehouse/base.html' %}

{% block title %}–§—ñ–Ω–∞–Ω—Å–æ–≤–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ - –ë—É–¥–°–∫–ª–∞–¥{% endblock %}

{% block content %}
<div class="container-fluid">
    <h3 class="h4 mb-4">üìä –§—ñ–Ω–∞–Ω—Å–æ–≤–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞</h3>

    <div class="row g-4 mb-4">
        <!-- –ì–†–ê–§–Ü–ö 1: –í–ò–¢–†–ê–¢–ò –ü–û –û–ë'–Ñ–ö–¢–ê–• -->
        <div class="col-lg-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-white border-0 fw-bold">
                    üí∏ –í–∏—Ç—Ä–∞—Ç–∏ –ø–æ –æ–±'—î–∫—Ç–∞—Ö (–°–ø–∏—Å–∞–Ω–Ω—è)
                </div>
                <div class="card-body">
                    <canvas id="whChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <!-- –ì–†–ê–§–Ü–ö 2: –î–ò–ù–ê–ú–Ü–ö–ê -->
        <div class="col-lg-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-white border-0 fw-bold">
                    üìà –î–∏–Ω–∞–º—ñ–∫–∞ –≤–∏—Ç—Ä–∞—Ç (–ø–æ –º—ñ—Å—è—Ü—è—Ö)
                </div>
                <div class="card-body">
                    <canvas id="trendChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- –¢–ê–ë–õ–ò–¶–Ø: –¢–û–ü –í–ò–¢–†–ê–¢ -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 fw-bold d-flex justify-content-between align-items-center">
            <span>üèÜ –¢–û–ü-5 –ù–∞–π–∑–∞—Ç—Ä–∞—Ç–Ω—ñ—à–∏—Ö –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤</span>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4">–ú–∞—Ç–µ—Ä—ñ–∞–ª</th>
                        <th>–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                        <th class="text-end pe-4">–°—É–º–∞ –≤–∏—Ç—Ä–∞—Ç</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in top_materials %}
                    <tr>
                        <td class="ps-4 fw-bold">{{ item.material__name }}</td>
                        <td>{{ item.total_qty }} {{ item.material__unit }}</td>
                        <td class="text-end pe-4 fw-bold text-danger">
                            {{ item.total_spent }} ‚Ç¥
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-center py-4 text-muted">–î–∞–Ω–∏—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- 1. –°–ø–æ—á–∞—Ç–∫—É –≤–∞–Ω—Ç–∞–∂–∏–º–æ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- 2. –ü–æ—Ç—ñ–º –≤–∏–∫–æ–Ω—É—î–º–æ –Ω–∞—à –∫–æ–¥ -->
<script>
    // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∑ Django
    const whLabels = {{ wh_labels|safe }};
    const whData = {{ wh_data|safe }};
    const monthLabels = {{ month_labels|safe }};
    const monthData = {{ month_data|safe }};

    // –ì–†–ê–§–Ü–ö 1: –ü–ò–†–Ü–ì (–í–ò–¢–†–ê–¢–ò –ü–û –°–ö–õ–ê–î–ê–•)
    if (whLabels.length > 0) {
        new Chart(document.getElementById('whChart'), {
            type: 'doughnut',
            data: {
                labels: whLabels,
                datasets: [{
                    data: whData,
                    backgroundColor: [
                        '#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545', 
                        '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' }
                }
            }
        });
    } else {
        const ctx = document.getElementById('whChart').getContext('2d');
        ctx.font = "16px Arial";
        ctx.textAlign = "center";
        ctx.fillText("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ —Å–ø–∏—Å–∞–Ω–Ω—è", 150, 75);
    }

    // –ì–†–ê–§–Ü–ö 2: –õ–Ü–ù–Ü–ô–ù–ò–ô (–î–ò–ù–ê–ú–Ü–ö–ê)
    if (monthLabels.length > 0) {
        new Chart(document.getElementById('trendChart'), {
            type: 'line',
            data: {
                labels: monthLabels,
                datasets: [{
                    label: '–í–∏—Ç—Ä–∞—Ç–∏ (–≥—Ä–Ω)',
                    data: monthData,
                    borderColor: '#198754',
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    } else {
        const ctx = document.getElementById('trendChart').getContext('2d');
        ctx.font = "16px Arial";
        ctx.textAlign = "center";
        ctx.fillText("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –∑–∞ –ø–µ—Ä—ñ–æ–¥", 150, 75);
    }
</script>
{% endblock %}