{% extends 'warehouse/base.html' %}

{% block title %}{{ warehouse.name }} - –ó–≤—ñ—Ç{% endblock %}

{% block extra_css %}
<style>
    /* –°—Ç–∏–ª—ñ –¥–ª—è –¥—Ä—É–∫—É */
    @media print {
        #sidebar, header, .no-print { display: none !important; }
        #content-wrapper { margin: 0 !important; padding: 0 !important; }
        body { background: white !important; }
        .card { border: none !important; box-shadow: none !important; }
        .container, .container-fluid { max-width: 100% !important; width: 100% !important; padding: 0 !important; margin: 0 !important; }
        .badge { border: 1px solid #000; color: #000 !important; }
        a { text-decoration: none !important; color: black !important; }
        .btn-view-details { display: none !important; }
        /* –•–æ–≤–∞—î–º–æ —Ñ–æ—Ä–º—É —Ñ—ñ–ª—å—Ç—Ä—É –ø—Ä–∏ –¥—Ä—É—Ü—ñ */
        form { display: none !important; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- –ö–ù–û–ü–ö–ò (–ù–µ –¥–ª—è –¥—Ä—É–∫—É) -->
    <div class="d-flex justify-content-between align-items-center mb-3 no-print">
        <div>
            <a href="{% url 'index' %}" class="btn btn-outline-secondary btn-sm me-2">‚Üê –ù–∞–∑–∞–¥</a>
            <h3 class="h4 mb-0 d-inline-block align-middle">{{ warehouse.name }}</h3>
        </div>
        <button onclick="window.print()" class="btn btn-dark">
            <i class="bi bi-printer me-2"></i> –î—Ä—É–∫ –∑–≤—ñ—Ç—É
        </button>
    </div>

    <!-- –ö–ê–†–¢–ö–ê –°–ö–õ–ê–î–£ -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body p-4">
            
            <!-- –ó–ê–ì–û–õ–û–í–û–ö –ó–í–Ü–¢–£ -->
            <div class="d-flex justify-content-between align-items-start mb-4 border-bottom pb-3">
                <div>
                    <h5 class="text-muted text-uppercase small mb-1">–°–∫–ª–∞–¥ / –û–±'—î–∫—Ç</h5>
                    <h2 class="fw-bold mb-0">{{ warehouse.name }}</h2>
                    <p class="text-muted mb-0">{{ warehouse.address|default:"–ê–¥—Ä–µ—Å–∞ –Ω–µ –≤–∫–∞–∑–∞–Ω–∞" }}</p>
                </div>
                <div class="text-end">
                    <h5 class="text-muted text-uppercase small mb-1">–í–∞—Ä—Ç—ñ—Å—Ç—å –∑–∞–ª–∏—à–∫—ñ–≤</h5>
                    <h2 class="fw-bold text-success mb-0">{{ total_value }} <small class="fs-6 text-muted">–≥—Ä–Ω</small></h2>
                    <p class="text-muted mb-0 small">–ú–í–û: {{ warehouse.responsible.get_full_name|default:warehouse.responsible.username }}</p>
                </div>
            </div>

            <div class="row g-4 mb-5">
                <!-- –¢–ê–ë–õ–ò–¶–Ø –ó–ê–õ–ò–®–ö–Ü–í -->
                <div class="col-lg-7">
                    <h5 class="mb-3 fw-bold">üì¶ –ü–æ—Ç–æ—á–Ω—ñ –∑–∞–ª–∏—à–∫–∏</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered align-middle mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>–ú–∞—Ç–µ—Ä—ñ–∞–ª</th>
                                    <th class="text-center" style="width: 100px;">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                                    <th class="text-end" style="width: 100px;">–°—É–º–∞</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in balance_list %}
                                <tr>
                                    <td>
                                        <b>{{ item.name }}</b>
                                        {% if item.min_limit > 0 and item.quantity <= item.min_limit %}
                                            <span class="badge bg-danger ms-2 no-print">–ú–∞–ª–æ!</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center fw-bold">
                                        {{ item.quantity }} <small class="text-muted">{{ item.unit }}</small>
                                    </td>
                                    <td class="text-end fw-bold">{{ item.total_sum }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-3">–°–∫–ª–∞–¥ –ø–æ—Ä–æ–∂–Ω—ñ–π.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- DRILL-DOWN: –¢–û–ü –í–ò–¢–†–ê–¢ -->
                <div class="col-lg-5">
                    <h5 class="mb-3 fw-bold text-danger">üí∏ –¢–æ–ø –≤–∏—Ç—Ä–∞—Ç (–∫—É–¥–∏ –ø—ñ—à–ª–∏ –≥—Ä–æ—à—ñ)</h5>
                    <div class="card border-danger shadow-sm">
                        <ul class="list-group list-group-flush">
                            {% for expense in top_expenses %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">{{ expense.material__name }}</div>
                                    <small class="text-muted">–°–ø–∏—Å–∞–Ω–æ: {{ expense.total_qty }} {{ expense.material__unit }}</small>
                                </div>
                                <span class="badge bg-danger rounded-pill fs-6">
                                    -{{ expense.total_money|floatformat:0 }} ‚Ç¥
                                </span>
                            </li>
                            {% empty %}
                            <li class="list-group-item text-center text-muted p-3">
                                –í–∏—Ç—Ä–∞—Ç —â–µ –Ω–µ –±—É–ª–æ.
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

            <hr>

            <!-- –Ü–°–¢–û–†–Ü–Ø –†–£–•–£ -->
            <div class="d-flex justify-content-between align-items-center mb-3 mt-4">
                <h5 class="mb-0 fw-bold">üìú –Ü—Å—Ç–æ—Ä—ñ—è –æ–ø–µ—Ä–∞—Ü—ñ–π</h5>
            </div>

            <!-- –ü–ê–ù–ï–õ–¨ –§–Ü–õ–¨–¢–†–Ü–í -->
            <div class="card mb-4 bg-light border-0 no-print">
                <div class="card-body py-3">
                    <form method="get" class="row g-2 align-items-end">
                        <div class="col-md-3 col-6">
                            <label class="small text-muted fw-bold mb-1">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü—ñ—ó</label>
                            <select name="type" class="form-select form-select-sm">
                                <option value="">–í—Å—ñ —Ç–∏–ø–∏</option>
                                <option value="IN" {% if filter_type == 'IN' %}selected{% endif %}>üü¢ –ü—Ä–∏—Ö—ñ–¥</option>
                                <option value="OUT" {% if filter_type == 'OUT' %}selected{% endif %}>üî¥ –í–∏—Ç—Ä–∞—Ç–∞</option>
                                <option value="TRANSFER" {% if filter_type == 'TRANSFER' %}selected{% endif %}>üîµ –ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3 col-6">
                            <label class="small text-muted fw-bold mb-1">–ú–∞—Ç–µ—Ä—ñ–∞–ª</label>
                            <select name="material" class="form-select form-select-sm">
                                <option value="">–í—Å—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏</option>
                                {% for m in all_materials %}
                                    <option value="{{ m.id }}" {% if filter_material == m.id %}selected{% endif %}>{{ m.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-2 col-6">
                            <label class="small text-muted fw-bold mb-1">–ó –¥–∞—Ç–∏</label>
                            <input type="date" name="date_from" class="form-control form-control-sm" value="{{ filter_date_from|default:'' }}">
                        </div>
                        <div class="col-md-2 col-6">
                            <label class="small text-muted fw-bold mb-1">–ü–æ –¥–∞—Ç—É</label>
                            <input type="date" name="date_to" class="form-control form-control-sm" value="{{ filter_date_to|default:'' }}">
                        </div>

                        <div class="col-md-2 d-flex gap-1">
                            <button type="submit" class="btn btn-primary btn-sm w-100" title="–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏">
                                <i class="bi bi-funnel-fill"></i>
                            </button>
                            <a href="{% url 'warehouse_detail' warehouse.id %}" class="btn btn-outline-secondary btn-sm" title="–°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏">
                                <i class="bi bi-x-lg"></i>
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–¢–∏–ø</th>
                            <th>–ú–∞—Ç–µ—Ä—ñ–∞–ª</th>
                            <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                            <th>–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
                            <th class="text-end no-print">–î—ñ—ó</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tr in transactions %}
                        <tr style="cursor: pointer;" onclick="window.location='{% url 'transaction_detail' tr.id %}'">
                            <td class="text-muted small">{{ tr.created_at|date:"d.m.Y H:i" }}</td>
                            <td>
                                {% if tr.transaction_type == 'IN' %}
                                    <span class="badge bg-success bg-opacity-10 text-success border border-success">–ü—Ä–∏—Ö—ñ–¥</span>
                                {% elif tr.transaction_type == 'OUT' %}
                                    <span class="badge bg-danger bg-opacity-10 text-danger border border-danger">–í–∏—Ç—Ä–∞—Ç–∞</span>
                                {% elif tr.transaction_type == 'TRANSFER' %}
                                    <span class="badge bg-info bg-opacity-10 text-info border border-info">–ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è</span>
                                {% endif %}
                            </td>
                            <td class="fw-bold">{{ tr.material.name }}</td>
                            <td>
                                <b>{{ tr.quantity }}</b> {{ tr.material.unit }}
                            </td>
                            <td class="text-muted small text-truncate" style="max-width: 200px;">
                                {{ tr.description|default:"-" }}
                            </td>
                            <td class="text-end no-print btn-view-details">
                                <a href="{% url 'transaction_detail' tr.id %}" class="btn btn-sm btn-light border" title="–î–µ—Ç–∞–ª—ñ">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                –ó–∞ –≤–∞—à–∏–º –∑–∞–ø–∏—Ç–æ–º –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>
{% endblock %}