{% extends 'warehouse/base.html' %}
{% load static %}

{% block title %}–î–∞—à–±–æ—Ä–¥ –ü—Ä–æ–µ–∫—Ç—É{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold mb-0">üèóÔ∏è –ó–≤–µ–¥–µ–Ω–Ω—è –ø–æ –ø—Ä–æ–µ–∫—Ç—É</h3>
            <span class="text-muted small">–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ –¥–ª—è –≤–ª–∞—Å–Ω–∏–∫–∞</span>
        </div>
        <div class="btn-group">
             <a href="{% url 'concrete_analytics' %}" class="btn btn-outline-primary">
                <i class="bi bi-bricks me-1"></i> –ë–µ—Ç–æ–Ω (–î–µ—Ç–∞–ª—å–Ω–æ)
            </a>
            <a href="{% url 'financial_report' %}" class="btn btn-outline-success">
                <i class="bi bi-cash-stack me-1"></i> –§—ñ–Ω–∞–Ω—Å–∏
            </a>
        </div>
    </div>

    <!-- 1. –í–ï–†–•–ù–Ü KPI (–ì—Ä–æ—à—ñ) -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100 bg-primary text-white">
                <div class="card-body">
                    <div class="opacity-75 small text-uppercase fw-bold">–û—Å–≤–æ—î–Ω–æ –±—é–¥–∂–µ—Ç—É</div>
                    <div class="fs-3 fw-bold">{{ total_spent|floatformat:0 }} ‚Ç¥</div>
                    <div class="mt-2 small opacity-50">
                        <i class="bi bi-calendar-month me-1"></i> –£ —Ü—å–æ–º—É –º—ñ—Å—è—Ü—ñ: {{ spent_this_month|floatformat:0 }} ‚Ç¥
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100 border-start border-4 border-danger">
                <div class="card-body">
                    <div class="text-danger small text-uppercase fw-bold">–ö—Ä–∏—Ç–∏—á–Ω—ñ –∑–∞–ª–∏—à–∫–∏</div>
                    {% if critical_items %}
                        <div class="fs-4 fw-bold text-dark">{{ critical_items|length }} –ø–æ–∑–∏—Ü—ñ–π</div>
                        <small class="text-muted">–ü–æ—Ç—Ä–µ–±—É—é—Ç—å —É–≤–∞–≥–∏ –ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è</small>
                    {% else %}
                        <div class="fs-4 fw-bold text-success">0</div>
                        <small class="text-success">–í—Å–µ –≤ –Ω–æ—Ä–º—ñ</small>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-muted small text-uppercase fw-bold">–û—Å—Ç–∞–Ω–Ω—ñ –ø–æ–¥—ñ—ó</div>
                        <div class="fs-4 fw-bold">{{ recent_logs|length }}</div>
                    </div>
                    <i class="bi bi-activity fs-1 text-muted opacity-25"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        
        <!-- 2. –ë–ï–¢–û–ù–£–í–ê–ù–ù–Ø (–ì—Ä–∞—Ñ—ñ–∫ + –¢–∞–±–ª–∏—Ü—è) -->
        <div class="col-lg-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-0 fw-bold d-flex justify-content-between align-items-center">
                    <span>üìä –ü—Ä–æ–≥—Ä–µ—Å –±–µ—Ç–æ–Ω—É–≤–∞–Ω–Ω—è</span>
                    <a href="{% url 'concrete_analytics' %}" class="btn btn-sm btn-link text-decoration-none">–î–µ—Ç–∞–ª—å–Ω—ñ—à–µ &rarr;</a>
                </div>
                <div class="card-body">
                    <!-- –ì—Ä–∞—Ñ—ñ–∫ -->
                    <div class="mb-4" style="height: 200px; position: relative;">
                        <canvas id="concreteProgressChart"></canvas>
                        <div class="text-center text-muted small d-none mt-5" data-empty-msg="concrete">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫–∞</div>
                    </div>

                    <!-- –¢–∞–±–ª–∏—Ü—è -->
                    <div class="table-responsive">
                        <table class="table table-sm table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>–ï—Ç–∞–ø</th>
                                    <th class="text-center">–ü–ª–∞–Ω</th>
                                    <th class="text-center">–§–∞–∫—Ç</th>
                                    <th class="text-end">%</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stage in concrete_stages %}
                                <tr>
                                    <td>{{ stage.name }}</td>
                                    <td class="text-center text-muted">{{ stage.plan }}</td>
                                    <td class="text-center fw-bold">{{ stage.fact }}</td>
                                    <td class="text-end">
                                        {% if stage.percent >= 100 %}
                                            <span class="text-success fw-bold"><i class="bi bi-check-lg"></i> 100%</span>
                                        {% else %}
                                            <div class="progress" style="height: 6px; width: 60px; display: inline-flex;">
                                                <div class="progress-bar" role="progressbar" style="width: {{ stage.percent }}%"></div>
                                            </div>
                                            <small class="ms-1">{{ stage.percent }}%</small>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="4" class="text-center py-3 text-muted">–î–∞–Ω—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ. –Ü–º–ø–æ—Ä—Ç—É–π—Ç–µ –∫–æ—à—Ç–æ—Ä–∏—Å.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. –û–°–¢–ê–ù–ù–Ü –ü–û–î–Ü–á -->
        <div class="col-lg-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-0 fw-bold">
                    üîî –û—Å—Ç–∞–Ω–Ω—ñ –ø–æ–¥—ñ—ó –Ω–∞ –º–∞–π–¥–∞–Ω—á–∏–∫—É
                </div>
                <div class="list-group list-group-flush">
                    {% for log in recent_logs %}
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1 small fw-bold">{{ log.title }}</h6>
                            <small class="text-muted" style="font-size: 0.75rem;">{{ log.time|date:"d.m H:i" }}</small>
                        </div>
                        <p class="mb-1 small text-muted">{{ log.desc }}</p>
                    </div>
                    {% empty %}
                    <div class="text-center py-3 text-muted small">–ü–æ–¥—ñ–π –Ω–µ–º–∞—î</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- DATA FOR CHARTS -->
{{ concrete_stages|json_script:"concrete-stages-data" }}

{% endblock %}

{% block extra_js %}
<!-- –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –ª–æ–∫–∞–ª—å–Ω–∏–π Chart.js (vendor) -->
<script src="{% static 'vendor/chartjs/chart.umd.min.js' %}"></script>

<!-- –õ–æ–≥—ñ–∫–∞ –≥—Ä–∞—Ñ—ñ–∫—ñ–≤ -->
<script src="{% static 'warehouse/js/project_dashboard_charts.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (window.ProjectDashboardCharts) {
            window.ProjectDashboardCharts.init();
        }
    });
</script>
{% endblock %}