{% extends 'warehouse/base.html' %}
{% block title %}Прийом поставки{% endblock %}
{% block extra_css %}
<style>
    /* Глибокий темний фон сторінки */
    body { background-color: #121212; color: #e0e0e0; } 
    
    /* Картка трохи світліша, щоб виділятися */
    .card { 
        background-color: #1e1e1e; 
        border: 1px solid #333; 
        color: #fff; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    
    .form-control { 
        background-color: #2c2c2c; 
        border-color: #444; 
        color: #fff; 
    }
    .form-control:focus { 
        background-color: #333; 
        color: #fff; 
        border-color: #0d6efd; 
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    /* Яскраві лейбли замість тьмяних */
    .text-label { 
        color: #a0a0a0 !important; /* Світло-сірий */
        text-transform: uppercase; 
        font-size: 0.75rem; 
        font-weight: bold; 
        letter-spacing: 0.5px;
        margin-bottom: 5px;
        display: block;
    }

    /* Блок з плановими показниками - виділяємо контрастним фоном */
    .plan-box {
        background-color: #2c2c2c;
        border: 1px solid #444;
        border-radius: 8px;
        padding: 15px;
        margin-top: 10px;
    }
    
    .item-row {
        background-color: #1e1e1e;
        border: 1px solid #333;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .btn-camera { 
        border: 2px dashed #666; 
        background-color: #2c2c2c; 
        color: #ccc; 
        border-radius: 12px; 
        padding: 20px; 
        text-align: center; 
        cursor: pointer; 
    }
    .btn-camera.active { 
        border-color: #198754; 
        background-color: #198754; 
        color: #fff; 
    }
    
    .qty-input { 
        font-size: 1.5rem; 
        font-weight: bold; 
        text-align: center; 
        background: #121212; 
        color: #fff; 
        border: 1px solid #555; 
        width: 100px;
    }
    
    .fixed-bottom-action { 
        position: fixed; bottom: 0; left: 0; width: 100%; 
        background: #1e1e1e; padding: 15px; 
        border-top: 1px solid #333; z-index: 1000; 
    }
    
    /* Перемикач */
    .action-switch .btn-check:checked + .btn-outline-success { background-color: #198754; color: white; border-color: #198754; }
    .action-switch .btn-check:checked + .btn-outline-danger { background-color: #dc3545; color: white; border-color: #dc3545; }
    .action-switch .btn { color: #ccc; border-color: #555; }
    .action-switch .btn:hover { color: #fff; background-color: #333; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-3 pb-5 mb-5" style="max-width: 600px;">
    
    <!-- Навігація -->
    <div class="d-flex align-items-center mb-4">
        <a href="{% url 'index' %}" class="btn btn-outline-light btn-sm rounded-circle me-3 border-secondary"><i class="bi bi-chevron-left"></i></a>
        <div>
            <h5 class="mb-0 fw-bold text-white">Прийом поставки #{{ order.id }}</h5>
            <small class="text-secondary">{{ order.warehouse.name }}</small>
        </div>
    </div>

    <!-- Повідомлення про помилки -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="receiptForm">
        {% csrf_token %}
        
        <!-- ІНФО ПРО ДОСТАВКУ -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-6">
                        <span class="text-label text-info">Постачальник</span>
                        <div class="fw-bold fs-5">
                            {% if order.selected_supplier %}
                                {{ order.selected_supplier.name }}
                            {% else %}
                                {{ order.supplier_info|default:"-" }}
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-6 text-end">
                        <span class="text-label text-info">Авто</span>
                        <div class="fw-bold fs-5">{{ order.vehicle_number|default:"-" }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- СПИСОК ТОВАРІВ -->
        <h6 class="text-label mb-3 ps-1 text-white">Товари до прийому ({{ order.items.count }})</h6>
        
        <div id="items-list">
            {% for item in order.items.all %}
            <div class="item-row shadow-sm">
                <!-- Назва товару -->
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <h4 class="fw-bold mb-0 text-white">{{ item.material.name }}</h4>
                        <small class="text-secondary">{{ item.material.article }}</small>
                    </div>
                    <span class="badge bg-secondary border border-secondary">{{ item.material.unit }}</span>
                </div>
                
                <!-- Блок ПЛАН vs ФАКТ -->
                <div class="plan-box d-flex justify-content-between align-items-center">
                    <div>
                        <span class="text-label text-warning mb-0">План (Треба)</span>
                        <span class="fs-2 fw-bold text-white">{{ item.quantity|floatformat:2 }}</span>
                    </div>
                    
                    <div class="text-end">
                        <span class="text-label text-success mb-2">Факт (Є)</span>
                        <div class="input-group input-group-sm justify-content-end" style="width: 140px;">
                            <button class="btn btn-secondary border-secondary" type="button" onclick="adjQty('{{ item.id }}', -1)">−</button>
                            <input type="number" step="0.01" name="qty_{{ item.id }}" id="qty_{{ item.id }}" 
                                   class="form-control qty-input p-0" 
                                   value="{{ item.quantity|stringformat:'.2f' }}">
                            <button class="btn btn-secondary border-secondary" type="button" onclick="adjQty('{{ item.id }}', 1)">+</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- ПЕРЕМИКАЧ ДІЇ -->
        <div class="btn-group w-100 mb-4 action-switch shadow-sm" role="group">
            <input type="radio" class="btn-check" name="action" value="confirm" id="actConfirm" checked onchange="toggleMode()">
            <label class="btn btn-outline-success py-3" for="actConfirm">
                <i class="bi bi-check-circle-fill me-2"></i> Все вірно
            </label>

            <input type="radio" class="btn-check" name="action" value="reject" id="actReject" onchange="toggleMode()">
            <label class="btn btn-outline-danger py-3" for="actReject">
                <i class="bi bi-x-circle-fill me-2"></i> Відмова
            </label>
        </div>

        <!-- БЛОК ВІДХИЛЕННЯ -->
        <div id="block-reject" style="display: none;">
            <div class="mb-3">
                <label class="form-label text-danger fw-bold">Причина відмови</label>
                <textarea name="reject_reason" class="form-control" rows="3" placeholder="Опишіть проблему (брак, не той товар)..."></textarea>
            </div>
        </div>

        <!-- ФОТО -->
        <h6 class="text-label mb-2 mt-4 text-white">Фото-доказ <span class="text-danger">*</span></h6>
        <div class="mb-5">
            <label for="cameraInput" class="btn-camera w-100 d-block shadow-sm" id="cameraLabel">
                <i class="bi bi-camera-fill fs-1 d-block mb-2 text-secondary"></i>
                <span id="cameraText" class="fw-bold">Зробити фото</span>
                <input type="file" name="proof_photo" id="cameraInput" accept="image/*" capture="environment" hidden onchange="previewFile()">
            </label>
            <div id="previewContainer" class="mt-3 text-center" style="display:none;">
                <img id="previewImg" src="" class="img-fluid rounded shadow border border-secondary" style="max-height: 250px;">
                <div class="mt-2 text-success fw-bold"><i class="bi bi-check-lg"></i> Фото додано</div>
            </div>
        </div>

        <!-- КНОПКА ДІЇ -->
        <div class="fixed-bottom-action">
            <button type="submit" id="mainSubmitBtn" class="btn btn-success btn-lg w-100 py-3 fw-bold shadow">
                <i class="bi bi-box-seam me-2"></i> ОПРИБУТКУВАТИ
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Fix commas in inputs
        document.querySelectorAll('.qty-input').forEach(input => {
            if(input.value.includes(',')) input.value = input.value.replace(',', '.');
        });
    });

    function adjQty(itemId, delta) {
        const input = document.getElementById('qty_' + itemId);
        let val = parseFloat(input.value) || 0;
        val += delta;
        if(val < 0) val = 0;
        input.value = parseFloat(val.toFixed(2));
    }

    function toggleMode() {
        const isReject = document.getElementById('actReject').checked;
        const btn = document.getElementById('mainSubmitBtn');
        const rejectBlock = document.getElementById('block-reject');
        
        if (isReject) {
            rejectBlock.style.display = 'block';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-danger');
            btn.innerHTML = '<i class="bi bi-x-circle me-2"></i> ПОВЕРНУТИ ПОСТАЧАЛЬНИКУ';
        } else {
            rejectBlock.style.display = 'none';
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-success');
            btn.innerHTML = '<i class="bi bi-box-seam me-2"></i> ОПРИБУТКУВАТИ';
        }
    }

    function previewFile() {
        const preview = document.getElementById('previewImg');
        const container = document.getElementById('previewContainer');
        const file = document.getElementById('cameraInput').files[0];
        
        if (file) {
            const reader = new FileReader();
            reader.onloadend = function() {
                preview.src = reader.result;
                container.style.display = 'block';
                document.getElementById('cameraLabel').classList.add('active');
                document.getElementById('cameraText').innerText = "Перезняти фото";
            }
            reader.readAsDataURL(file);
        }
    }
</script>
{% endblock %}