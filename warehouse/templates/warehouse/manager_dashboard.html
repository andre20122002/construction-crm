{% extends 'warehouse/base.html' %}

{% block title %}–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞–∫—É–ø—ñ–≤–ª—è–º–∏{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="h4 fw-bold">üõ†Ô∏è –¶–µ–Ω—Ç—Ä –∑–∞–∫—É–ø—ñ–≤–µ–ª—å</h3>
        <div class="btn-group">
            <a href="?status=new" class="btn btn-outline-primary {% if current_status == 'new' %}active{% endif %}">
                –ù–æ–≤—ñ <span class="badge bg-primary text-white ms-1">{{ count_new }}</span>
            </a>
            <a href="?status=rfq" class="btn btn-outline-warning text-dark {% if current_status == 'rfq' %}active{% endif %}">
                –¢–µ–Ω–¥–µ—Ä–∏ (RFQ) <span class="badge bg-warning text-dark ms-1">{{ count_rfq }}</span>
            </a>
            <a href="?" class="btn btn-outline-secondary">–í—Å—ñ –∞–∫—Ç–∏–≤–Ω—ñ</a>
        </div>
    </div>

    <!-- FILTER BAR -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body py-3">
            <form method="get" class="row g-3 align-items-center">
                <div class="col-md-3">
                    <select name="warehouse" class="form-select" onchange="this.form.submit()">
                        <option value="">–í—Å—ñ –æ–±'—î–∫—Ç–∏</option>
                        {% for wh in warehouses %}
                            <option value="{{ wh.id }}" {% if request.GET.warehouse == wh.id|stringformat:"s" %}selected{% endif %}>{{ wh.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select name="priority" class="form-select" onchange="this.form.submit()">
                        <option value="">–ë—É–¥—å-—è–∫–∏–π –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç</option>
                        <option value="high" {% if request.GET.priority == 'high' %}selected{% endif %}>üî¥ –¢–µ—Ä–º—ñ–Ω–æ–≤–æ</option>
                        <option value="normal" {% if request.GET.priority == 'normal' %}selected{% endif %}>üü° –ó–≤–∏—á–∞–π–Ω–∏–π</option>
                    </select>
                </div>
            </form>
        </div>
    </div>

    <!-- ORDERS TABLE -->
    <div class="card shadow-sm border-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4">ID / –î–∞—Ç–∞</th>
                        <th>–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ (–ü—Ä–µ–≤'—é)</th>
                        <th>–û–±'—î–∫—Ç</th>
                        <th>–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ê–≤—Ç–æ—Ä</th>
                        <th class="text-end pe-4">–î—ñ—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr style="cursor: pointer;" onclick="window.location='{% url 'manager_order_detail' order.id %}'">
                        <td class="ps-4">
                            <span class="fw-bold">#{{ order.id }}</span><br>
                            <small class="text-muted">{{ order.created_at|date:"d.m" }}</small>
                        </td>
                        <td>
                            <!-- –í–ò–í–û–î–ò–ú–û –°–ü–ò–°–û–ö –¢–û–í–ê–†–Ü–í -->
                            <div class="fw-bold text-primary">
                                {% for item in order.items.all|slice:":2" %}
                                    <div>‚Ä¢ {{ item.material.name }} ({{ item.quantity|floatformat:0 }} {{ item.material.unit }})</div>
                                {% endfor %}
                                {% if order.items.count > 2 %}
                                    <small class="text-muted fst-italic">+ —â–µ {{ order.items.count|add:"-2" }} –ø–æ–∑.</small>
                                {% endif %}
                            </div>
                        </td>
                        <td>{{ order.warehouse.name }}</td>
                        <td>
                            {% if order.priority == 'high' %}
                                <span class="badge bg-danger">–¢–µ—Ä–º—ñ–Ω–æ–≤–æ</span>
                            {% elif order.priority == 'low' %}
                                <span class="badge bg-success">–ù–µ –≥–æ—Ä–∏—Ç—å</span>
                            {% else %}
                                <span class="badge bg-light text-dark border">–ù–æ—Ä–º</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if order.status == 'new' %}<span class="badge bg-primary">–ù–æ–≤–∞</span>
                            {% elif order.status == 'rfq' %}<span class="badge bg-warning text-dark">RFQ</span>
                            {% elif order.status == 'purchasing' %}<span class="badge bg-info text-dark">–ö—É–ø—ñ–≤–ª—è</span>
                            {% elif order.status == 'in_transit' %}<span class="badge bg-secondary">–í –¥–æ—Ä–æ–∑—ñ</span>
                            {% elif order.status == 'completed' or order.status == 'approved' %}<span class="badge bg-success">–í–∏–∫–æ–Ω–∞–Ω–æ</span>
                            {% endif %}
                        </td>
                        <td class="small text-muted">
                            {{ order.created_by.get_full_name|default:order.created_by.username }}
                        </td>
                        <td class="text-end pe-4" onclick="event.stopPropagation();">
                            <a href="{% url 'print_order_pdf' order.id %}" target="_blank" class="btn btn-sm btn-outline-secondary me-1" title="–î—Ä—É–∫ –Ω–∞–∫–ª–∞–¥–Ω–æ—ó">
                                <i class="bi bi-printer"></i>
                            </a>
                            <a href="{% url 'manager_order_detail' order.id %}" class="btn btn-sm btn-dark">
                                <i class="bi bi-gear-fill"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="7" class="text-center py-5 text-muted">–ó–∞—è–≤–æ–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}