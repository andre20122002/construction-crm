{% extends 'warehouse/base.html' %}

{% block title %}–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –æ–±'—î–∫—Ç—ñ–≤{% endblock %}

{% block content %}
<div class="container-fluid">
    <h3 class="mb-4 fw-bold"><i class="bi bi-buildings-fill me-2"></i> –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –æ–±'—î–∫—Ç—ñ–≤ (–ë—é–¥–∂–µ—Ç–∏)</h3>

    <!-- –ì–†–ê–§–Ü–ö -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-header bg-white border-0 fw-bold">
            üìä –ë—é–¥–∂–µ—Ç vs –§–∞–∫—Ç–∏—á–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏
        </div>
        <div class="card-body">
            <canvas id="comparisonChart" style="max-height: 400px;"></canvas>
        </div>
    </div>

    <!-- –¢–ê–ë–õ–ò–¶–Ø -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
            <span class="fw-bold">–î–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ –æ–±'—î–∫—Ç–∞—Ö</span>
            <button onclick="window.print()" class="btn btn-sm btn-outline-secondary no-print"><i class="bi bi-printer"></i> –î—Ä—É–∫</button>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 text-center">
                <thead class="bg-dark text-white">
                    <tr>
                        <th class="text-start">–û–±'—î–∫—Ç</th>
                        <th>–ú–í–û (–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π)</th>
                        <th>–ó–∞–≥–∞–ª—å–Ω–∏–π –±—é–¥–∂–µ—Ç</th>
                        <th>–í–∏—Ç—Ä–∞—á–µ–Ω–æ (–§–∞–∫—Ç)</th>
                        <th>–í —Ä–æ–±–æ—Ç—ñ (–ó–∞—è–≤–∫–∏)</th>
                        <th>–ó–∞–ª–∏—à–æ–∫ –±—é–¥–∂–µ—Ç—É</th>
                        <th>–ü—Ä–æ–≥–Ω–æ–∑ (–ø—ñ—Å–ª—è –∑–∞—è–≤–æ–∫)</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in report_data %}
                    <tr>
                        <td class="text-start fw-bold">{{ row.name }}</td>
                        <td class="small text-muted">{{ row.responsible }}</td>
                        
                        <!-- –ë—é–¥–∂–µ—Ç -->
                        <td class="fw-bold">{{ row.budget|floatformat:0 }} ‚Ç¥</td>
                        
                        <!-- –í–∏—Ç—Ä–∞—á–µ–Ω–æ -->
                        <td class="text-danger fw-bold">-{{ row.spent|floatformat:0 }} ‚Ç¥</td>
                        
                        <!-- –í —Ä–æ–±–æ—Ç—ñ -->
                        <td class="text-warning small">-{{ row.active_commitments|floatformat:0 }} ‚Ç¥</td>
                        
                        <!-- –ó–∞–ª–∏—à–æ–∫ (—Ñ–∞–∫—Ç–∏—á–Ω–∏–π) -->
                        <td class="fw-bold {% if row.balance < 0 %}text-danger{% else %}text-success{% endif %}">
                            {{ row.balance|floatformat:0 }} ‚Ç¥
                        </td>

                        <!-- –ü—Ä–æ–≥–Ω–æ–∑ -->
                        <td class="fw-bold {% if row.forecast < 0 %}text-danger{% else %}text-primary{% endif %}">
                            {{ row.forecast|floatformat:0 }} ‚Ç¥
                        </td>

                        <!-- –°—Ç–∞—Ç—É—Å -->
                        <td>
                            {% if row.status == 'critical' %}
                                <span class="badge bg-danger">–ü–ï–†–ï–í–ò–¢–†–ê–¢–ê!</span>
                            {% elif row.status == 'warning' %}
                                <span class="badge bg-warning text-dark">–ö—Ä–∏—Ç–∏—á–Ω–æ</span>
                            {% else %}
                                <span class="badge bg-success">–í –Ω–æ—Ä–º—ñ</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="8" class="py-4 text-muted">–û–±'—î–∫—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="card-footer bg-light small text-muted">
            * <b>–í —Ä–æ–±–æ—Ç—ñ</b> ‚Äî —Å—É–º–∞ –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞—è–≤–æ–∫, —è–∫—ñ —â–µ –Ω–µ —Å–ø–∏—Å–∞–Ω—ñ.<br>
            * <b>–ü—Ä–æ–≥–Ω–æ–∑</b> = –ë—é–¥–∂–µ—Ç - –í–∏—Ç—Ä–∞—á–µ–Ω–æ - –í —Ä–æ–±–æ—Ç—ñ. –ü–æ–∫–∞–∑—É—î —Ä–µ–∞–ª—å–Ω–∏–π –∑–∞–ª–∏—à–æ–∫ –∫–æ—à—Ç—ñ–≤ –ø—ñ—Å–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –≤—Å—ñ—Ö –ø–æ—Ç–æ—á–Ω–∏—Ö –ø–ª–∞–Ω—ñ–≤.
        </div>
    </div>
</div>

<!-- DATA FOR JS -->
<script id="chart-labels" type="application/json">{{ chart_labels|safe }}</script>
<script id="chart-budget" type="application/json">{{ chart_budget|safe }}</script>
<script id="chart-spent" type="application/json">{{ chart_spent|safe }}</script>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const labels = JSON.parse(document.getElementById('chart-labels').textContent);
        const budget = JSON.parse(document.getElementById('chart-budget').textContent);
        const spent = JSON.parse(document.getElementById('chart-spent').textContent);

        new Chart(document.getElementById('comparisonChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '–§–∞–∫—Ç–∏—á–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏',
                        data: spent,
                        backgroundColor: '#dc3545',
                        borderRadius: 4,
                        order: 1
                    },
                    {
                        label: '–ë—é–¥–∂–µ—Ç–Ω–∏–π –ª—ñ–º—ñ—Ç',
                        data: budget,
                        backgroundColor: '#198754',
                        // –†–æ–±–∏–º–æ –±—é–¥–∂–µ—Ç —Ç—Ä–æ—Ö–∏ —à–∏—Ä—à–∏–º —ñ –ø—Ä–æ–∑–æ—Ä—ñ—à–∏–º, —â–æ–± –±—É–ª–æ –≤–∏–¥–Ω–æ –Ω–∞–∫–ª–∞–¥–∞–Ω–Ω—è
                        backgroundColor: 'rgba(25, 135, 84, 0.2)',
                        borderColor: '#198754',
                        borderWidth: 2,
                        borderRadius: 4,
                        type: 'bar', 
                        barPercentage: 1.2, // –®–∏—Ä—à–∏–π —Å—Ç–æ–≤–ø—á–∏–∫
                        order: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterBody: function(context) {
                                // –î–æ–¥–∞—î–º–æ —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞–ª–∏—à–∫—É –≤ —Ç—É–ª—Ç—ñ–ø
                                const idx = context[0].dataIndex;
                                const b = budget[idx];
                                const s = spent[idx];
                                const diff = b - s;
                                return `–ó–∞–ª–∏—à–æ–∫: ${diff.toFixed(2)} ‚Ç¥`;
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}