{% extends 'warehouse/base.html' %}

{% block title %}–§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π –∑–≤—ñ—Ç{% endblock %}

{% block content %}
<div class="container-fluid">
    <h3 class="mb-4 fw-bold"><i class="bi bi-pie-chart-fill me-2"></i> –§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π –∑–≤—ñ—Ç</h3>

    <!-- –§—ñ–ª—å—Ç—Ä–∏ -->
    <form method="get" class="card shadow-sm mb-4 border-0 bg-light">
        <div class="card-body row g-2 align-items-end">
            <div class="col-md-3">
                <label class="small text-muted fw-bold">–ü–µ—Ä—ñ–æ–¥ –∑</label>
                <input type="date" name="date_from" class="form-control" value="{{ date_from|default:'' }}">
            </div>
            <div class="col-md-3">
                <label class="small text-muted fw-bold">–ø–æ</label>
                <input type="date" name="date_to" class="form-control" value="{{ date_to|default:'' }}">
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">–ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏</button>
            </div>
            <div class="col-md-3 text-end">
                <div class="small text-muted">–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞ –≤–∏—Ç—Ä–∞—Ç</div>
                <div class="h3 fw-bold text-success mb-0">{{ total_spent }} <small>‚Ç¥</small></div>
            </div>
        </div>
    </form>

    <div class="row g-4 mb-4">
        <!-- 1. –ë–Æ–î–ñ–ï–¢–ò –ü–û –û–ë'–Ñ–ö–¢–ê–• -->
        <div class="col-lg-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-white border-0 fw-bold">üè¢ –í–∏—Ç—Ä–∞—Ç–∏ vs –ë—é–¥–∂–µ—Ç –ø–æ –æ–±'—î–∫—Ç–∞—Ö</div>
                <div class="card-body">
                    <canvas id="whChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <!-- 2. –ü–û–°–¢–ê–ß–ê–õ–¨–ù–ò–ö–ò -->
        <div class="col-lg-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-white border-0 fw-bold">ü§ù –¢–û–ü –ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫—ñ–≤ (–∑–∞ —Å—É–º–æ—é)</div>
                <div class="card-body">
                    <canvas id="supChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. –î–ò–ù–ê–ú–Ü–ö–ê -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-0 fw-bold">üìà –î–∏–Ω–∞–º—ñ–∫–∞ –≤–∏—Ç—Ä–∞—Ç (–ø–æ –º—ñ—Å—è—Ü—è—Ö)</div>
        <div class="card-body">
            <canvas id="trendChart" style="max-height: 250px;"></canvas>
        </div>
    </div>

    <!-- –¢–ê–ë–õ–ò–¶–Ø –ü–ï–†–ï–í–ò–©–ï–ù–¨ -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-danger text-white border-0 fw-bold">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> –ö–æ–Ω—Ç—Ä–æ–ª—å –±—é–¥–∂–µ—Ç—É (–ü–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è)
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th>–û–±'—î–∫—Ç</th>
                        <th class="text-end">–õ—ñ–º—ñ—Ç</th>
                        <th class="text-end">–í–∏—Ç—Ä–∞—á–µ–Ω–æ</th>
                        <th class="text-end">–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody>
                    {% for wh, data in warehouses_stats.items %}
                    <tr>
                        <td class="fw-bold">{{ wh }}</td>
                        <td class="text-end">{{ data.limit }} ‚Ç¥</td>
                        <td class="text-end fw-bold">{{ data.spent|floatformat:2 }} ‚Ç¥</td>
                        <td class="text-end">
                            {% if data.overrun > 0 %}
                                <span class="badge bg-danger">Overrun: +{{ data.overrun|floatformat:2 }} ‚Ç¥</span>
                            {% else %}
                                <span class="badge bg-success">OK</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="text-center text-muted p-3">–î–∞–Ω–∏—Ö –Ω–µ–º–∞—î</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- –î–ê–ù–Ü –î–õ–Ø –ì–†–ê–§–Ü–ö–Ü–í (–ü—Ä–∏—Ö–æ–≤–∞–Ω—ñ –±–ª–æ–∫–∏ JSON) -->
<script id="wh-labels" type="application/json">{{ wh_labels|safe }}</script>
<script id="wh-spent" type="application/json">{{ wh_spent|safe }}</script>
<script id="wh-limits" type="application/json">{{ wh_limits|safe }}</script>

<script id="sup-labels" type="application/json">{{ sup_labels|safe }}</script>
<script id="sup-data" type="application/json">{{ sup_data|safe }}</script>

<script id="date-labels" type="application/json">{{ date_labels|safe }}</script>
<script id="date-values" type="application/json">{{ date_values|safe }}</script>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥—É JSON –∑ HTML
        function getData(id) {
            try {
                return JSON.parse(document.getElementById(id).textContent);
            } catch (e) {
                console.error("Error parsing JSON for " + id, e);
                return [];
            }
        }

        // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∑ –ø—Ä–∏—Ö–æ–≤–∞–Ω–∏—Ö –±–ª–æ–∫—ñ–≤
        const whLabels = getData('wh-labels');
        const whSpent = getData('wh-spent');
        const whLimits = getData('wh-limits');
        
        const supLabels = getData('sup-labels');
        const supData = getData('sup-data');
        
        const dateLabels = getData('date-labels');
        const dateValues = getData('date-values');

        // 1. –ë–Æ–î–ñ–ï–¢–ò
        const ctxWh = document.getElementById('whChart');
        if (ctxWh && whLabels.length > 0) {
            new Chart(ctxWh, {
                type: 'bar',
                data: {
                    labels: whLabels,
                    datasets: [
                        {
                            label: '–í–∏—Ç—Ä–∞—á–µ–Ω–æ',
                            data: whSpent,
                            backgroundColor: '#dc3545',
                            borderRadius: 4,
                            order: 1
                        },
                        {
                            label: '–õ—ñ–º—ñ—Ç –±—é–¥–∂–µ—Ç—É',
                            data: whLimits,
                            backgroundColor: 'rgba(25, 135, 84, 0.0)', // –ü—Ä–æ–∑–æ—Ä–∏–π —Ñ–æ–Ω
                            borderColor: '#198754',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            type: 'line', // –õ—ñ–Ω—ñ—è –ø–æ–≤–µ—Ä—Ö
                            pointRadius: 0,
                            order: 0
                        }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // 2. –ü–û–°–¢–ê–ß–ê–õ–¨–ù–ò–ö–ò
        const ctxSup = document.getElementById('supChart');
        if (ctxSup && supLabels.length > 0) {
            new Chart(ctxSup, {
                type: 'doughnut',
                data: {
                    labels: supLabels,
                    datasets: [{
                        data: supData,
                        backgroundColor: ['#0d6efd', '#ffc107', '#20c997', '#6f42c1', '#fd7e14'],
                        borderWidth: 0
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { position: 'right' } } 
                }
            });
        }

        // 3. –î–ò–ù–ê–ú–Ü–ö–ê
        const ctxTrend = document.getElementById('trendChart');
        if (ctxTrend && dateLabels.length > 0) {
            new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: dateLabels,
                    datasets: [{
                        label: '–í–∏—Ç—Ä–∞—Ç–∏ (–≥—Ä–Ω)',
                        data: dateValues,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true } } 
                }
            });
        }
    });
</script>
{% endblock %}