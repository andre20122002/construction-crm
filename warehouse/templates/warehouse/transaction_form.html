{% extends 'warehouse/base.html' %}

{% block title %}–ê–∫—Ç —Å–ø–∏—Å–∞–Ω–Ω—è{% endblock %}

{% block extra_css %}
<style>
    /* –ü–µ—Ä–µ–º–∏–∫–∞—á —Ç–∏–ø—É (–†–æ–±–æ—Ç–∞ / –í—Ç—Ä–∞—Ç–∞) */
    .type-selector .btn-check:checked + .btn {
        border-width: 2px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transform: scale(1.02);
        font-weight: bold;
    }
    .btn-work-checked { 
        background-color: #ffc107 !important; color: #000 !important; border-color: #ffc107 !important; 
    }
    .btn-loss-checked { 
        background-color: #dc3545 !important; color: #fff !important; border-color: #dc3545 !important; 
    }

    /* –ö–Ω–æ–ø–∫–∞ —Ñ–æ—Ç–æ */
    .btn-photo {
        border: 2px dashed #adb5bd; background: #f8f9fa; border-radius: 12px;
        padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s;
        display: flex; align-items: center; justify-content: center; flex-direction: column;
        color: #6c757d;
    }
    .btn-photo:active { border-color: #198754; background: #d1e7dd; color: #0f5132; }
    .btn-photo.has-file { border-color: #198754; background: #d1e7dd; color: #0f5132; }

    /* –ü–∞–Ω–µ–ª—å –∑–∞–ª–∏—à–∫—ñ–≤ (Stock Panel) */
    .stock-panel {
        background-color: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 12px;
        padding: 15px; margin-bottom: 20px; display: none; /* –ü—Ä–∏—Ö–æ–≤–∞–Ω–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º */
        animation: fadeIn 0.3s ease-in-out;
    }
    .stock-val-big { font-size: 1.8rem; font-weight: 800; color: #198754; line-height: 1; }
    
    /* –ö–Ω–æ–ø–∫–∏ —à–≤–∏–¥–∫–æ–≥–æ –≤–≤–æ–¥—É */
    .quick-btn { min-width: 50px; font-weight: bold; }

    /* –°–∫–∞–Ω–µ—Ä */
    #scanner-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 9999; display: none;
        flex-direction: column; justify-content: center; align-items: center;
    }
    #reader { width: 100%; max-width: 500px; border-radius: 12px; overflow: hidden; background: #000; }
    .scan-overlay-btn { margin-top: 20px; padding: 12px 30px; font-size: 1.1rem; border-radius: 30px; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5" style="max-width: 600px;">
    
    <!-- –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û –°–ö–ê–ù–ï–†–ê -->
    <div id="scanner-modal">
        <div class="text-white mb-3 text-center">
            <i class="bi bi-qr-code-scan fs-1"></i><br>
            –ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥
        </div>
        <div id="reader"></div>
        <button class="btn btn-light text-danger fw-bold scan-overlay-btn" onclick="stopScanner()">
            <i class="bi bi-x-lg me-2"></i> –°–∫–∞—Å—É–≤–∞—Ç–∏
        </button>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="h4 fw-bold mb-0">üìâ –ê–∫—Ç —Å–ø–∏—Å–∞–Ω–Ω—è</h3>
        <a href="{% url 'index' %}" class="btn-close"></a>
    </div>

    <form method="post" enctype="multipart/form-data" id="transactionForm">
        {% csrf_token %}

        <!-- 1. –¢–ò–ü –û–ü–ï–†–ê–¶–Ü–á -->
        <div class="mb-4">
            <div class="btn-group w-100 type-selector" role="group">
                <input type="radio" class="btn-check" name="ui_type" id="optWork" autocomplete="off" checked onchange="setType('OUT')">
                <label class="btn btn-outline-warning py-3" for="optWork">
                    <i class="bi bi-hammer fs-4 d-block mb-1"></i>
                    –ù–∞ —Ä–æ–±–æ—Ç–∏
                </label>

                <input type="radio" class="btn-check" name="ui_type" id="optLoss" autocomplete="off" onchange="setType('LOSS')">
                <label class="btn btn-outline-danger py-3" for="optLoss">
                    <i class="bi bi-trash3 fs-4 d-block mb-1"></i>
                    –í—Ç—Ä–∞—Ç–∞ / –ë—ñ–π
                </label>
            </div>
            <!-- –ü—Ä–∏—Ö–æ–≤–∞–Ω–µ –ø–æ–ª–µ —Ñ–æ—Ä–º–∏ Django -->
            <div style="display:none;">{{ form.transaction_type }}</div>
        </div>

        <!-- 2. –î–ê–¢–ê –¢–ê –ó–ú–Ü–ù–ê -->
        <div class="row g-3 mb-3">
            <div class="col-6">
                <label class="form-label small fw-bold text-muted">–î–∞—Ç–∞</label>
                {{ form.date }}
            </div>
            <div class="col-6">
                <label class="form-label small fw-bold text-muted">–ó–º—ñ–Ω–∞</label>
                {{ form.shift }}
            </div>
        </div>

        <!-- 3. –°–ö–õ–ê–î -->
        <div class="mb-3">
            <label class="form-label small fw-bold text-muted">–ó —è–∫–æ–≥–æ —Å–∫–ª–∞–¥—É?</label>
            {{ form.warehouse }}
        </div>

        <!-- 4. –ú–ê–¢–ï–†–Ü–ê–õ -->
        <div class="mb-3">
            <label class="form-label small fw-bold text-muted">–©–æ —Å–ø–∏—Å—É—î–º–æ?</label>
            <div class="input-group">
                {{ form.material }}
                <button class="btn btn-dark" type="button" onclick="startScanner()">
                    <i class="bi bi-qr-code-scan"></i>
                </button>
            </div>
        </div>

        <!-- === –ù–û–í–ï: –ü–ê–ù–ï–õ–¨ –ó–ê–õ–ò–®–ö–Ü–í === -->
        <div id="stockPanel" class="stock-panel shadow-sm">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="small text-success text-uppercase fw-bold">–î–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ —Å–∫–ª–∞–¥—ñ</div>
                    <div class="stock-val-big" id="stockValueDisplay">0</div>
                    <div class="small text-muted" id="stockUnitDisplay">–æ–¥.</div>
                </div>
                <div class="text-end">
                    <button type="button" class="btn btn-outline-success fw-bold" onclick="setMaxQty()">
                        <i class="bi bi-arrow-up-circle me-1"></i> MAX
                        <br><span style="font-size: 0.7em">–í–µ—Å—å –∑–∞–ª–∏—à–æ–∫</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 5. –ö–Ü–õ–¨–ö–Ü–°–¢–¨ (–ó –∫–Ω–æ–ø–∫–∞–º–∏) -->
        <div class="mb-4">
            <label class="form-label small fw-bold text-muted">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥–æ —Å–ø–∏—Å–∞–Ω–Ω—è</label>
            
            <div class="input-group input-group-lg mb-2">
                <button class="btn btn-outline-secondary" type="button" onclick="adjQty(-1)">‚àí</button>
                <input type="number" name="quantity" id="qtyInput" class="form-control text-center fw-bold" step="0.01" placeholder="0.00" required>
                <button class="btn btn-outline-secondary" type="button" onclick="adjQty(1)">+</button>
            </div>
            
            <!-- –®–≤–∏–¥–∫—ñ –∫–Ω–æ–ø–∫–∏ -->
            <div class="d-flex justify-content-between gap-2">
                <button type="button" class="btn btn-sm btn-light border flex-grow-1 quick-btn" onclick="adjQty(-5)">-5</button>
                <button type="button" class="btn btn-sm btn-light border flex-grow-1 quick-btn" onclick="adjQty(-1)">-1</button>
                <button type="button" class="btn btn-sm btn-light border flex-grow-1 quick-btn" onclick="adjQty(1)">+1</button>
                <button type="button" class="btn btn-sm btn-light border flex-grow-1 quick-btn" onclick="adjQty(5)">+5</button>
            </div>
            <div id="qtyWarning" class="form-text text-danger fw-bold" style="display:none;">‚õî –ü–µ—Ä–µ–≤–∏—â—É—î –∑–∞–ª–∏—à–æ–∫!</div>
        </div>

        <!-- 6. –í–ò–î –†–û–ë–Ü–¢ -->
        <div id="workTypeBlock" class="mb-3">
            <label class="form-label small fw-bold text-muted">–ï—Ç–∞–ø —Ä–æ–±—ñ—Ç</label>
            {{ form.work_type }}
        </div>

        <!-- 7. –ö–û–ú–ï–ù–¢–ê–† -->
        <div class="mb-4">
            <label class="form-label small fw-bold text-muted">–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
            {{ form.description }}
        </div>

        <!-- 8. –§–û–¢–û -->
        <div class="mb-5">
            <label class="btn-photo w-100" id="photoBtn">
                <i class="bi bi-camera fs-2 mb-2"></i>
                <span>–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</span>
                <input type="file" name="photo" id="photoInput" accept="image/*" hidden onchange="previewPhoto()">
            </label>
        </div>

        <div class="d-grid">
            <button type="submit" class="btn btn-primary btn-lg py-3 shadow" id="submitBtn">
                <i class="bi bi-check-lg me-2"></i> –°–ü–ò–°–ê–¢–ò
            </button>
        </div>

    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<!-- –î–∞–Ω—ñ –∑ –±–µ–∫–µ–Ω–¥—É -->
<script id="stock-data" type="application/json">{{ stock_json|safe }}</script>
<script id="barcode-data" type="application/json">{{ barcode_json|safe }}</script>

<script>
    const whSelect = document.getElementById('id_warehouse');
    const matSelect = document.getElementById('id_material');
    const typeSelect = document.getElementById('type-select') || document.querySelector('[name="transaction_type"]');
    const qtyInput = document.getElementById('qtyInput');
    const stockData = JSON.parse(document.getElementById('stock-data').textContent);
    const barcodeMap = JSON.parse(document.getElementById('barcode-data').textContent);
    
    let currentMaxStock = 0; // –ó–±–µ—Ä—ñ–≥–∞—î –ø–æ—Ç–æ—á–Ω–∏–π –º–∞–∫—Å–∏–º—É–º

    document.addEventListener('DOMContentLoaded', function() {
        // –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è Django –≤—ñ–¥–∂–µ—Ç—ñ–≤
        whSelect.classList.add('form-select', 'form-select-lg');
        matSelect.classList.add('form-select', 'form-select-lg');
        
        // –î–∞—Ç–∞ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
        const dateInput = document.getElementById('id_date');
        if (!dateInput.value) dateInput.valueAsDate = new Date();

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å—Ç–∞–Ω—É
        const optLoss = document.getElementById('optLoss');
        if (typeSelect.value === 'LOSS') {
            optLoss.checked = true;
            setType('LOSS');
        } else {
            setType('OUT');
        }

        // –ó–∞–ø—É—Å–∫ –ª–æ–≥—ñ–∫–∏
        filterMaterials();
        
        // –Ø–∫—â–æ –ø–µ—Ä–µ–¥–∞–Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ URL
        const urlParams = new URLSearchParams(window.location.search);
        const preselectedMatId = urlParams.get('material');
        if (preselectedMatId) {
            setTimeout(() => { matSelect.value = preselectedMatId; updateStockDisplay(); }, 300);
        }
    });

    // --- –õ–û–ì–Ü–ö–ê –¢–ò–ü–Ü–í (–†–æ–±–æ—Ç–∞/–í—Ç—Ä–∞—Ç–∞) ---
    function setType(val) {
        typeSelect.value = val;
        const workTypeBlock = document.getElementById('workTypeBlock');
        const btnWork = document.querySelector('label[for="optWork"]');
        const btnLoss = document.querySelector('label[for="optLoss"]');

        if (val === 'OUT') {
            btnWork.classList.add('btn-work-checked');
            btnLoss.classList.remove('btn-loss-checked');
            if(workTypeBlock) workTypeBlock.style.display = 'block';
        } else {
            btnWork.classList.remove('btn-work-checked');
            btnLoss.classList.add('btn-loss-checked');
            if(workTypeBlock) workTypeBlock.style.display = 'none';
        }
    }

    // --- –§–Ü–õ–¨–¢–†–ê–¶–Ü–Ø –¢–ê –ó–ê–õ–ò–®–ö–ò ---
    function filterMaterials() {
        const whId = whSelect.value;
        const availableItems = stockData[whId] || {};
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –≤ —Å–ø–∏—Å–∫—É —Ç—ñ–ª—å–∫–∏ —Ç–µ, —â–æ —î (–∞–±–æ –¥–æ–∑–≤–æ–ª—è—î–º–æ –≤—Å–µ, –∞–ª–µ –∑ –ø–æ–∑–Ω–∞—á–∫–æ—é)
        for (let i = 0; i < matSelect.options.length; i++) {
            const opt = matSelect.options[i];
            const matId = opt.value;
            if (!matId) continue;

            if (availableItems[matId] && availableItems[matId] > 0) {
                if (!opt.text.includes(' [')) {
                    opt.text = `${opt.text} [–Ñ: ${availableItems[matId]}]`;
                }
            }
        }
        updateStockDisplay();
    }

    function updateStockDisplay() {
        const whId = whSelect.value;
        const matId = matSelect.value;
        const panel = document.getElementById('stockPanel');
        const valDisplay = document.getElementById('stockValueDisplay');
        
        if (whId && matId && stockData[whId]) {
            currentMaxStock = parseFloat(stockData[whId][matId] || 0);
            
            if (currentMaxStock > 0) {
                valDisplay.textContent = currentMaxStock;
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
                currentMaxStock = 0;
            }
        } else {
            panel.style.display = 'none';
            currentMaxStock = 0;
        }
        validateQty(); // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω–µ –≤–≤–µ–¥–µ–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è
    }

    // --- –ö–ï–†–£–í–ê–ù–ù–Ø –ö–Ü–õ–¨–ö–Ü–°–¢–Æ ---
    function setMaxQty() {
        if (currentMaxStock > 0) {
            qtyInput.value = currentMaxStock;
            validateQty();
        }
    }

    function adjQty(delta) {
        let val = parseFloat(qtyInput.value) || 0;
        val += delta;
        val = parseFloat(val.toFixed(2));
        
        // –õ–æ–≥—ñ–∫–∞ –æ–±–º–µ–∂–µ–Ω—å
        if (val < 0) val = 0;
        
        // –Ø–∫—â–æ –Ω–∞–º–∞–≥–∞—î–º–æ—Å—å –≤–≤–µ—Å—Ç–∏ –±—ñ–ª—å—à–µ –Ω—ñ–∂ —î - –æ–±–º–µ–∂—É—î–º–æ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ, –∞–ª–µ –∑—Ä—É—á–Ω–æ)
        // –ê–ª–µ –∫—Ä–∞—â–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–ø–µ—Ä–µ–¥–∏—Ç–∏, —Ä–∞–ø—Ç–æ–º –ø–µ—Ä–µ—Å–æ—Ä—Ç
        
        qtyInput.value = val;
        validateQty();
    }

    function validateQty() {
        const val = parseFloat(qtyInput.value) || 0;
        const warning = document.getElementById('qtyWarning');
        const btn = document.getElementById('submitBtn');

        if (currentMaxStock > 0 && val > currentMaxStock) {
            warning.style.display = 'block';
            qtyInput.classList.add('is-invalid');
            btn.classList.add('disabled'); // –ë–ª–æ–∫—É—î–º–æ –∫–Ω–æ–ø–∫—É
        } else {
            warning.style.display = 'none';
            qtyInput.classList.remove('is-invalid');
            btn.classList.remove('disabled');
        }
    }

    qtyInput.addEventListener('input', validateQty);

    // --- –§–û–¢–û –ü–†–ï–í'–Æ ---
    function previewPhoto() {
        const file = document.getElementById('photoInput').files[0];
        const btn = document.getElementById('photoBtn');
        if (file) {
            btn.classList.add('has-file');
            btn.innerHTML = `<i class="bi bi-check-lg fs-1 mb-2"></i><span class="fw-bold">–§–æ—Ç–æ –¥–æ–¥–∞–Ω–æ!</span>`;
        }
    }

    // --- –°–ö–ê–ù–ï–† ---
    let html5QrcodeScanner = null;

    function startScanner() {
        document.getElementById('scanner-modal').style.display = 'flex';
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
            (decodedText) => {
                stopScanner();
                if (barcodeMap[decodedText]) {
                    const item = barcodeMap[decodedText];
                    if(navigator.vibrate) navigator.vibrate(200); 
                    
                    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Å–∫–ª–∞–¥ —ñ –º–∞—Ç–µ—Ä—ñ–∞–ª
                    const whId = whSelect.value;
                    const stock = stockData[whId] || {};
                    
                    matSelect.value = item.id;
                    updateStockDisplay();
                    
                    if (!stock[item.id]) {
                        alert(`–£–≤–∞–≥–∞! –ú–∞—Ç–µ—Ä—ñ–∞–ª—É "${item.name}" –Ω–µ–º–∞—î –Ω–∞ –æ–±–ª—ñ–∫—É —Ü—å–æ–≥–æ —Å–∫–ª–∞–¥—É.`);
                    }
                } else {
                    alert(`–®—Ç—Ä–∏—Ö–∫–æ–¥ ${decodedText} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.`);
                }
            }
        ).catch(err => {
            alert("–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏: " + err); 
            stopScanner();
        });
    }

    function stopScanner() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.clear();
                document.getElementById('scanner-modal').style.display = 'none';
            });
        } else {
            document.getElementById('scanner-modal').style.display = 'none';
        }
    }

    // –°–ª—É—Ö–∞—á—ñ –∑–º—ñ–Ω
    whSelect.addEventListener('change', () => {
        filterMaterials();
        updateStockDisplay();
    });
    matSelect.addEventListener('change', updateStockDisplay);

</script>
{% endblock %}