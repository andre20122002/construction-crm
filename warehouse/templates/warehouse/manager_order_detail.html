{% extends 'warehouse/base.html' %}

{% block title %}–ó–∞—è–≤–∫–∞ #{{ order.id }}{% endblock %}

{% block content %}
<div class="container-fluid pb-5">
    
    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <div class="text-muted small mb-1">
                <a href="{% url 'manager_dashboard' %}" class="text-decoration-none text-secondary">‚Üê –ù–∞–∑–∞–¥ –¥–æ —Å–ø–∏—Å–∫—É</a>
            </div>
            <h2 class="fw-bold mb-0">–ó–∞—è–≤–∫–∞ #{{ order.id }}</h2>
            <div class="mt-2">
                <span class="badge bg-light text-dark border">{{ order.get_priority_display }}</span>
                <span class="badge bg-light text-dark border">{{ order.get_status_display }}</span>
            </div>
        </div>
        <div class="text-end">
            
            <!-- üî• –ö–ù–û–ü–ö–ê –í–ò–î–ê–õ–ï–ù–ù–Ø (–¢—ñ–ª—å–∫–∏ –¥–ª—è Admin) üî• -->
            {% if user.is_staff %}
                <a href="{% url 'delete_order' order.id %}" 
                   class="btn btn-outline-danger mb-2 me-2"
                   onclick="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –∑–∞—è–≤–∫—É? –¶—é –¥—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏.')">
                    <i class="bi bi-trash-fill me-1"></i> –í–∏–¥–∞–ª–∏—Ç–∏
                </a>
            {% endif %}

            <!-- –ö–ù–û–ü–ö–ê –î–†–£–ö–£ -->
            <a href="{% url 'print_order_pdf' order.id %}" target="_blank" class="btn btn-outline-dark mb-2">
                <i class="bi bi-printer-fill me-2"></i> –î—Ä—É–∫ –Ω–∞–∫–ª–∞–¥–Ω–æ—ó
            </a>
        </div>
    </div>

    <div class="row g-4">
        <!-- LEFT COL: ITEMS & ACTIONS -->
        <div class="col-lg-8">
            
            <!-- –¢–ê–ë–õ–ò–¶–Ø –¢–û–í–ê–†–Ü–í -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">–ú–∞—Ç–µ—Ä—ñ–∞–ª</th>
                                <th class="text-center">–ö-—Å—Ç—å</th>
                                <th class="text-end pe-4">–¶—ñ–Ω–∞</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in order.items.all %}
                            <tr>
                                <td class="ps-4">
                                    <div class="fw-bold">{{ item.material.name }}</div>
                                    <small class="text-muted">{{ item.material.article }}</small>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-white text-dark border">{{ item.quantity|floatformat:2 }} {{ item.material.unit }}</span>
                                </td>
                                <td class="text-end pe-4">
                                    {% if item.supplier_price > 0 %}
                                        {{ item.supplier_price }} ‚Ç¥
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center py-4 text-muted">
                                    <i class="bi bi-basket3 fs-4 d-block mb-2"></i>
                                    –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä—ñ–≤ –ø–æ—Ä–æ–∂–Ω—ñ–π
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="bg-light">
                            <tr>
                                <td colspan="2" class="text-end fw-bold">–û—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∞ —Å—É–º–∞:</td>
                                <td class="text-end pe-4 fw-bold">{{ order.get_total_cost|floatformat:2 }} ‚Ç¥</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- –î–Ü–á –ú–ï–ù–ï–î–ñ–ï–†–ê -->
            {% if order.status == 'new' or order.status == 'rfq' %}
            <div class="card border-primary shadow-sm mb-4">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title text-primary mb-1">–ù–µ–æ–±—Ö—ñ–¥–Ω–∞ –æ–±—Ä–æ–±–∫–∞</h5>
                        <p class="card-text small text-muted mb-0">–û–±–µ—Ä—ñ—Ç—å –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞ –∞–±–æ —Å–∫–ª–∞–¥ –¥–ª—è –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</p>
                    </div>
                    <div class="btn-group">
                        <a href="{% url 'split_order' order.id %}" class="btn btn-outline-primary">
                            <i class="bi bi-scissors me-2"></i> –†–æ–∑–¥—ñ–ª–∏—Ç–∏
                        </a>
                        <a href="{% url 'manager_process_order' order.id %}" class="btn btn-primary px-4">
                            <i class="bi bi-arrow-right-circle me-2"></i> –û–±—Ä–æ–±–∏—Ç–∏
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- –Ü–ù–§–û –ü–†–û –î–û–°–¢–ê–í–ö–£ (–Ø–∫—â–æ –≤–∂–µ –≤ —Ä–æ–±–æ—Ç—ñ) -->
            {% if order.status == 'purchasing' or order.status == 'transit' or order.status == 'completed' %}
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white fw-bold">‚ÑπÔ∏è –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="small text-muted fw-bold">–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫ / –î–∂–µ—Ä–µ–ª–æ</label>
                            <div class="border rounded p-2 bg-light">
                                {% if order.source_warehouse %}
                                    <i class="bi bi-house-door text-primary me-2"></i> {{ order.source_warehouse.name }}
                                {% else %}
                                    <i class="bi bi-shop text-success me-2"></i> {{ order.selected_supplier.name|default:order.supplier_info|default:"-" }}
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="small text-muted fw-bold">–í–æ–¥—ñ–π / –ê–≤—Ç–æ</label>
                            <div class="border rounded p-2 bg-light">
                                {% if order.driver_name %}
                                    <i class="bi bi-truck me-2"></i> {{ order.driver_name }} ({{ order.vehicle_number }})
                                {% else %}
                                    <span class="text-muted small">–ù–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

        </div>

        <!-- RIGHT COL: INFO & CHAT -->
        <div class="col-lg-4">
            
            <!-- –Ü–ù–§–û –ó–ê–Ø–í–ö–ò -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">–î–µ—Ç–∞–ª—ñ</h6>
                    
                    <div class="mb-3">
                        <label class="small text-muted fw-bold d-block">–û–±'—î–∫—Ç</label>
                        <i class="bi bi-geo-alt-fill text-danger me-1"></i> {{ order.warehouse.name }}
                    </div>
                    
                    <div class="mb-3">
                        <label class="small text-muted fw-bold d-block">–°—Ç–≤–æ—Ä–∏–≤</label>
                        <i class="bi bi-person-fill me-1"></i> {{ order.created_by.get_full_name|default:order.created_by.username }}
                        <span class="text-muted small">({{ order.created_at|date:"d.m.Y H:i" }})</span>
                    </div>

                    {% if order.note %}
                    <div class="alert alert-secondary mb-0 small">
                        <i class="bi bi-chat-left-quote me-1"></i> {{ order.note }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- –ß–ê–¢ / –ö–û–ú–ï–ù–¢–ê–†–Ü -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white fw-bold">üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ</div>
                <div class="card-body bg-light">
                    <div class="chat-box mb-3" style="max-height: 200px; overflow-y: auto;">
                        {% for comment in comments %}
                            <div class="mb-2 p-2 rounded bg-white border shadow-sm small">
                                <div class="d-flex justify-content-between text-muted mb-1" style="font-size:0.8em">
                                    <strong>{{ comment.author.get_full_name|default:comment.author.username }}</strong>
                                    <span>{{ comment.created_at|date:"H:i" }}</span>
                                </div>
                                {{ comment.text }}
                            </div>
                        {% empty %}
                            <div class="text-center text-muted small">–ù–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</div>
                        {% endfor %}
                    </div>
                    <form method="post">
                        {% csrf_token %}
                        <div class="input-group input-group-sm">
                            <input type="text" name="comment_text" class="form-control" placeholder="–ù–∞–ø–∏—Å–∞—Ç–∏..." required>
                            <button class="btn btn-outline-primary" type="submit"><i class="bi bi-send"></i></button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}