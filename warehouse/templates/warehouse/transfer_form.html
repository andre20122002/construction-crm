<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5 mb-5" style="max-width: 650px;">
    <div class="card shadow border-info">
        <div class="card-header bg-info text-white">
            <h3 class="mb-0">üöö –ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤</h3>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                
                <h5 class="mt-3">1. –õ–æ–≥—ñ—Å—Ç–∏–∫–∞</h5>
                <hr>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.source_warehouse.label }}</label>
                        {{ form.source_warehouse }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">–ù–∞ —Å–∫–ª–∞–¥ (–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è)</label>
                        <select name="target_warehouse" class="form-select" required>
                            <option value="">-- –í–∏–±–µ—Ä—ñ—Ç—å —Å–∫–ª–∞–¥ --</option>
                            {% for wh in target_warehouses %}
                                <option value="{{ wh.pk }}">{{ wh.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <h5 class="mt-4">2. –î–µ—Ç–∞–ª—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª—É</h5>
                <hr>
                
                <div class="mb-3">
                    <label class="form-label">{{ form.material.label }}</label>
                    {{ form.material }}
                    
                    <div id="transfer-hint" class="alert alert-info mt-2 py-2" style="display: none;">
                        –ù–∞ —Å–∫–ª–∞–¥—ñ <b id="wh-name">...</b> –¥–æ—Å—Ç—É–ø–Ω–æ: <b id="stock-val" style="font-size: 1.2em;">0</b>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.quantity.label }}</label>
                        {{ form.quantity }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.price.label }}</label>
                        {{ form.price }}
                        <small class="form-text text-muted">–¶—ñ–Ω–∞ –¥–ª—è –æ–±–ª—ñ–∫—É.</small>
                    </div>
                </div>

                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-info btn-lg text-white">–û—Ñ–æ—Ä–º–∏—Ç–∏ –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è</button>
                    <a href="{% url 'index' %}" class="btn btn-secondary">–°–∫–∞—Å—É–≤–∞—Ç–∏</a>
                </div>
            </form>
        </div>
    </div>

    <div class="mt-5 mb-5">
        <h5 class="text-secondary">‚ÑπÔ∏è –î–æ–≤—ñ–¥–∫–∞: –ù–∞—è–≤–Ω—ñ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö</h5>
        <div class="table-responsive">
            <table class="table table-bordered table-sm bg-white">
                <thead class="table-light">
                    <tr>
                        <th>–°–∫–ª–∞–¥</th>
                        <th>–ù–∞—è–≤–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in all_balances %}
                    <tr>
                        <td class="fw-bold">{{ item.warehouse.name }}</td>
                        <td>
                            {% for mat, qty in item.items.items %}
                                <span class="badge bg-light text-dark border me-1">
                                    {{ mat.name }}: {{ qty }} {{ mat.unit }}
                                </span>
                            {% endfor %}
                        </td>
                    </tr>
                    {% empty %}
                        <tr><td colspan="2" class="text-center text-muted">–í—Å—ñ —Å–∫–ª–∞–¥–∏ –ø–æ—Ä–æ–∂–Ω—ñ</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- –ë–õ–û–ö –î–ê–ù–ò–• JSON -->
<!-- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –±–µ–∑–ø–µ—á–Ω–∏–π —Å–ø–æ—Å—ñ–± –ø–µ—Ä–µ–¥–∞—á—ñ –¥–∞–Ω–∏—Ö -->
<script id="full-stock-data-json" type="application/json">
{
    {% for entry in all_balances %}
        "{{ entry.warehouse.id }}": {
            "name": "{{ entry.warehouse.name }}",
            "items": {
                {% for mat, qty in entry.items.items %}
                    "{{ mat.id }}": "{{ qty }} {{ mat.unit }}"{% if not forloop.last %},{% endif %}
                {% endfor %}
            }
        }{% if not forloop.last %},{% endif %}
    {% endfor %}
}
</script>

<!-- –°–ö–†–ò–ü–¢ –õ–û–ì–Ü–ö–ò -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dataElement = document.getElementById('full-stock-data-json');
        let fullStockData = {};
        
        try {
            fullStockData = JSON.parse(dataElement.textContent);
        } catch (e) {
            console.error("–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–æ –∑–∞–ª–∏—à–∫–∏", e);
        }

        const sourceSelect = document.getElementById('id_source_warehouse');
        const materialSelect = document.getElementById('id_material');
        const hintBox = document.getElementById('transfer-hint');
        const whNameSpan = document.getElementById('wh-name');
        const stockValSpan = document.getElementById('stock-val');

        function checkAvailability() {
            const whId = sourceSelect.value;
            const matId = materialSelect.value;

            if (whId && matId) {
                if (fullStockData[whId]) {
                    const warehouseData = fullStockData[whId];
                    const stock = warehouseData.items[matId];

                    whNameSpan.textContent = warehouseData.name;
                    
                    if (stock) {
                        stockValSpan.textContent = stock;
                        hintBox.className = "alert alert-success mt-2 py-2";
                    } else {
                        stockValSpan.textContent = "0";
                        hintBox.className = "alert alert-danger mt-2 py-2";
                    }
                    hintBox.style.display = 'block';
                } else {
                    whNameSpan.textContent = "–¶–µ–π —Å–∫–ª–∞–¥";
                    stockValSpan.textContent = "0";
                    hintBox.className = "alert alert-danger mt-2 py-2";
                    hintBox.style.display = 'block';
                }
            } else {
                hintBox.style.display = 'none';
            }
        }

        if (sourceSelect && materialSelect) {
            sourceSelect.addEventListener('change', checkAvailability);
            materialSelect.addEventListener('change', checkAvailability);
        }
    });
</script>

</body>
</html>