{% extends 'warehouse/base.html' %}

{% block title %}–î–∞—à–±–æ—Ä–¥ - –ë—É–¥–°–∫–ª–∞–¥{% endblock %}

{% block extra_css %}
{% if role == 'foreman' %}
<style>
    /* === –¢–ï–ú–ù–ê –¢–ï–ú–ê –î–õ–Ø –ü–†–û–†–ê–ë–ê === */
    body { background-color: #212529 !important; color: #e9ecef !important; }
    header { background-color: #212529 !important; border-bottom: 1px solid #495057 !important; color: #fff !important; }
    header .btn-light { background-color: #343a40 !important; color: #fff !important; border: 1px solid #6c757d !important; }
    h2, h4, h5, .h4 { color: #fff !important; }
    .text-muted { color: #adb5bd !important; }
    .card { background-color: #2c3034; border-color: #495057; color: #fff; }
    .badge.bg-light { background-color: #495057 !important; color: #f8f9fa !important; border-color: #6c757d !important; }
    .btn-primary, .btn-warning { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    .badge.bg-secondary { background-color: #343a40 !important; border: 1px solid #6c757d; }
    .modal-content { background-color: #2c3034; color: #fff; border: 1px solid #495057; }
    .modal-header, .modal-footer { border-color: #495057; }
    .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
    
    .clickable-card:active { transform: scale(0.98); background-color: #343a40; }
    .clickable-card { transition: transform 0.1s; }

    /* –°—Ç–∏–ª—ñ –¥–ª—è —Å–∫–∞–Ω–µ—Ä–∞ */
    #scanner-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 9999; display: none;
        flex-direction: column; justify-content: center; align-items: center;
    }
    #reader { width: 100%; max-width: 500px; border-radius: 12px; overflow: hidden; background: #000; }
    .scan-overlay-btn {
        margin-top: 20px; padding: 12px 30px; font-size: 1.1rem; border-radius: 30px;
        z-index: 10000; box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
    }
    
    /* –ú—ñ–∫—Ä–æ-–∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ */
    .stat-card { background: #343a40; border-radius: 12px; padding: 15px; height: 100%; }
    .stat-value { font-size: 1.8rem; font-weight: bold; line-height: 1; }
    .stat-label { font-size: 0.75rem; text-transform: uppercase; color: #adb5bd; letter-spacing: 0.5px; }
    .recent-item { border-bottom: 1px solid #495057; padding: 10px 0; }
    .recent-item:last-child { border-bottom: none; }
</style>
{% endif %}
{% endblock %}

{% block content %}

    {% if role == 'foreman' %}
    <!-- === –Ü–ù–¢–ï–†–§–ï–ô–° –ü–†–û–†–ê–ë–ê (MOBILE) === -->
    
    <!-- –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û –°–ö–ê–ù–ï–†–ê -->
    <div id="scanner-modal">
        <div class="text-white mb-3 text-center">
            <i class="bi bi-qr-code-scan fs-1"></i><br>
            –ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –Ω–∞–∫–ª–∞–¥–Ω–æ—ó
        </div>
        <div id="reader"></div>
        <button class="btn btn-light text-danger fw-bold scan-overlay-btn" onclick="stopScanner()">
            <i class="bi bi-x-lg me-2"></i> –°–∫–∞—Å—É–≤–∞—Ç–∏
        </button>
    </div>
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h4 mb-0">üèóÔ∏è –ú—ñ–π –ú–∞–π–¥–∞–Ω—á–∏–∫</h2>
        <span class="badge bg-secondary">{{ my_warehouse.name|default:"–û–±'—î–∫—Ç –Ω–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ" }}</span>
    </div>

    <!-- 1. –®–í–ò–î–ö–Ü –î–Ü–á -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <a href="{% url 'create_order' %}" class="btn btn-primary text-white w-100 py-4 rounded-4 shadow-sm h-100 d-flex flex-column align-items-center justify-content-center">
                <i class="bi bi-cart-plus fs-1 mb-2"></i>
                <span class="fw-bold">–ó–∞–º–æ–≤–∏—Ç–∏</span>
            </a>
        </div>
        <div class="col-6 col-md-3">
            <a href="{% url 'add_transaction' %}?type=OUT" class="btn btn-warning text-dark w-100 py-4 rounded-4 shadow-sm h-100 d-flex flex-column align-items-center justify-content-center">
                <i class="bi bi-bricks fs-1 mb-2"></i>
                <span class="fw-bold">–°–ø–∏—Å–∞—Ç–∏</span>
            </a>
        </div>
        
        <div class="col-6 col-md-3">
            <button onclick="startScanner()" class="btn btn-dark text-white w-100 py-4 rounded-4 shadow-sm h-100 d-flex flex-column align-items-center justify-content-center border border-secondary">
                <i class="bi bi-qr-code-scan fs-1 mb-2"></i>
                <span class="fw-bold">–°–∫–∞–Ω–µ—Ä</span>
            </button>
        </div>

        <div class="col-6 col-md-3">
            <div class="card bg-info text-white h-100 rounded-4 border-0 shadow-sm" 
                 data-bs-toggle="modal" data-bs-target="#incomingModal" 
                 style="cursor: pointer;">
                <div class="card-body d-flex flex-column align-items-center justify-content-center text-center p-2">
                    <div class="display-6 fw-bold mb-1">{{ incoming_count }}</div>
                    <div class="small lh-1">–û—á—ñ–∫—É—î—Ç—å—Å—è –¥–æ—Å—Ç–∞–≤–æ–∫</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. –ú–Ü–ö–†–û-–ê–ù–ê–õ–Ü–¢–ò–ö–ê -->
    <h5 class="fw-bold text-muted mb-3">üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ —Ç–∏–∂–Ω—è</h5>
    <div class="row g-3 mb-4">
        <!-- –í–∏—Ç—Ä–∞—á–µ–Ω–æ –∑–∞ 7 –¥–Ω—ñ–≤ -->
        <div class="col-6">
            <div class="stat-card shadow-sm">
                <div class="stat-label mb-2">–°–ø–∏—Å–∞–Ω—å (7 –¥–Ω—ñ–≤)</div>
                <div class="d-flex align-items-center">
                    <i class="bi bi-journal-minus text-warning me-2 fs-4"></i>
                    <div class="stat-value text-white">{{ stats.spent_7_days }}</div>
                </div>
            </div>
        </div>
        <!-- –ö—Ä–∏—Ç–∏—á–Ω—ñ –∑–∞–ª–∏—à–∫–∏ -->
        <div class="col-6">
            <div class="stat-card shadow-sm border-danger" style="border-left: 3px solid #dc3545;">
                <div class="stat-label mb-2">–ó–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è</div>
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill text-danger me-2 fs-4"></i>
                    <div class="stat-value text-white">{{ stats.low_stock_count }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- –•—Ç–æ —Å–ø–∏—Å–∞–≤? (–û—Å—Ç–∞–Ω–Ω—ñ –¥—ñ—ó) -->
    {% if stats.recent_actions %}
    <div class="card shadow-sm mb-4 border-secondary">
        <div class="card-header bg-dark text-white border-secondary fw-bold py-2">
            <i class="bi bi-clock-history me-2"></i> –•—Ç–æ —Å–ø–∏—Å–∞–≤ (–û—Å—Ç–∞–Ω–Ω—ñ –¥—ñ—ó)
        </div>
        <div class="card-body bg-dark text-white py-1">
            {% for act in stats.recent_actions %}
            <div class="recent-item d-flex justify-content-between align-items-center">
                <div style="max-width: 60%;">
                    <div class="fw-bold text-truncate">{{ act.material.name }}</div>
                    <small class="text-muted" style="font-size: 0.75rem;">
                        <!-- –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –∞–≤—Ç–æ—Ä–∞ -->
                        {% if act.created_by %}
                            {{ act.created_by.get_full_name|default:act.created_by.username }}
                        {% else %}
                            –ù–µ–≤—ñ–¥–æ–º–∏–π
                        {% endif %}
                        ‚Ä¢ {{ act.created_at|date:"d.m H:i" }}
                    </small>
                </div>
                <div class="text-end">
                    <span class="badge bg-secondary border border-secondary text-white">
                        -{{ act.quantity|floatformat:0 }} {{ act.material.unit }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ -->
    {% if stats.top_materials %}
    <h6 class="fw-bold text-muted mb-2 small text-uppercase">üî• –ù–∞–π—á–∞—Å—Ç—ñ—à–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ</h6>
    <div class="d-flex gap-2 overflow-auto pb-3 mb-2">
        {% for mat in stats.top_materials %}
        <div class="bg-dark border border-secondary rounded p-2 px-3 shadow-sm" style="min-width: 140px;">
            <div class="small text-muted mb-1">–í—Å—å–æ–≥–æ –≤–∏—Ç—Ä–∞—á–µ–Ω–æ</div>
            <div class="fw-bold text-white">{{ mat.total_qty|floatformat:0 }} <small>{{ mat.material__unit }}</small></div>
            <div class="text-truncate small text-warning">{{ mat.material__name }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- 3. –ê–ö–¢–ò–í–ù–Ü –ó–ê–Ø–í–ö–ò (–í–ò–ü–†–ê–í–õ–ï–ù–ò–ô –ë–õ–û–ö) -->
    <h5 class="fw-bold text-muted mb-3 mt-2">üìã –ê–∫—Ç–∏–≤–Ω—ñ –ø—Ä–æ—Ü–µ—Å–∏</h5>
    
    <div class="row">
        {% for order in active_orders %}
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100 border-0 shadow-sm border-start border-4 clickable-card 
                    {% if order.status == 'in_transit' %}border-info{% elif order.status == 'purchasing' %}border-warning{% else %}border-secondary{% endif %}"
                    onclick="location.href='{% url 'foreman_order_detail' order.id %}'"
                    style="cursor: pointer;">
                    
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="badge rounded-pill 
                                {% if order.status == 'in_transit' %}bg-info text-dark
                                {% elif order.status == 'purchasing' %}bg-warning text-dark
                                {% else %}bg-light text-dark border{% endif %}">
                                {{ order.get_status_display }}
                            </span>
                            
                            {% if order.manager_last_viewed_at %}
                                <i class="bi bi-eye-fill text-success" title="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ"></i>
                            {% endif %}
                        </div>
                        
                        <!-- –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –ü–æ–∫–∞–∑—É—î–º–æ —Å–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤ -->
                        <h5 class="card-title fw-bold mb-1">
                            {% for item in order.items.all|slice:":2" %}
                                {{ item.material.name }}<br>
                            {% endfor %}
                            {% if order.items.count > 2 %}
                                <small class="text-muted" style="font-size:0.7em">+ —â–µ {{ order.items.count|add:"-2" }}</small>
                            {% endif %}
                        </h5>
                        <div class="text-muted">{{ order.items.count }} –ø–æ–∑–∏—Ü—ñ–π</div>
                        
                        <div class="mt-3 small">
                            {% if order.status == 'in_transit' %}
                                <span class="text-info fw-bold"><i class="bi bi-truck"></i> –ü—Ä–∏–±—É–≤–∞—î! –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –ø—Ä–∏–π–æ–º—É</span>
                            {% elif order.status == 'new' %}
                                <span class="text-muted"><i class="bi bi-hourglass-split"></i> –ß–µ–∫–∞—î –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è</span>
                            {% elif order.status == 'purchasing' %}
                                <span class="text-warning"><i class="bi bi-cart"></i> –ó–∞–∫—É–ø–ª—è—î—Ç—å—Å—è</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12 text-center py-5 text-muted">
                <i class="bi bi-clipboard-check fs-1 opacity-25"></i>
                <p class="mt-2">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞—è–≤–æ–∫</p>
            </div>
        {% endfor %}
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û -->
    <div class="modal fade" id="incomingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">üöö –á–¥–µ –Ω–∞ –æ–±'—î–∫—Ç</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="list-group list-group-flush">
                        {% for order in active_orders %}
                            {% if order.status == 'in_transit' or order.status == 'purchasing' %}
                            <a href="{% url 'foreman_order_detail' order.id %}" class="list-group-item list-group-item-action bg-transparent text-white border-secondary p-3">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <h6 class="fw-bold mb-0 text-white">–ó–∞—è–≤–∫–∞ #{{ order.id }}</h6>
                                    {% if order.status == 'in_transit' %}
                                        <span class="badge bg-info text-dark">–í –¥–æ—Ä–æ–∑—ñ</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">–ó–∞–∫—É–ø—ñ–≤–ª—è</span>
                                    {% endif %}
                                </div>
                                <div class="small text-muted">
                                    {% for item in order.items.all %}
                                        {{ item.material.name }} ({{ item.quantity }})<br>
                                    {% endfor %}
                                </div>
                                <small class="text-muted"><i class="bi bi-box-seam me-1"></i> –ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫: {{ order.supplier_info|default:"-" }}</small>
                            </a>
                            {% endif %}
                        {% empty %}
                            <div class="p-4 text-center text-muted">–ó–∞—Ä–∞–∑ –Ω—ñ—á–æ–≥–æ –Ω–µ —ó–¥–µ.</div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">–ó–∞–∫—Ä–∏—Ç–∏</button>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- === –ú–ï–ù–ï–î–ñ–ï–† (DESKTOP) === -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h4 mb-0">üìä –û–≥–ª—è–¥ –∫–æ–º–ø–∞–Ω—ñ—ó</h2>
        <a href="{% url 'export_stock_report' %}" class="btn btn-outline-dark btn-sm"><i class="bi bi-download"></i> –ï–∫—Å–ø–æ—Ä—Ç</a>
    </div>
    
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-primary text-white h-100">
                <div class="card-body">
                    <h6 class="opacity-75">–ù–æ–≤—ñ –∑–∞—è–≤–∫–∏ (RFQ)</h6>
                    <div class="display-4 fw-bold">{{ new_orders_count }}</div>
                    <a href="{% url 'manager_dashboard' %}?status=new" class="stretched-link"></a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-white h-100">
                <div class="card-body">
                    <h6 class="text-muted">–í –¥–æ—Ä–æ–∑—ñ</h6>
                    <div class="display-4 fw-bold text-info">{{ transit_orders_count }}</div>
                    <a href="{% url 'logistics_dashboard' %}" class="stretched-link"></a>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body py-2 d-flex flex-column justify-content-center align-items-center" style="min-height: 180px;">
                    <div style="width: 100%; height: 150px; position: relative;">
                        <canvas id="warehouseChart"></canvas>
                    </div>
                    <div id="noDataMessage" class="text-center text-muted" style="display: none; position: absolute;">
                        <i class="bi bi-graph-up fs-3 opacity-50"></i>
                        <p class="small mb-0 mt-1">–°–∫–ª–∞–¥–∏ –ø–æ—Ä–æ–∂–Ω—ñ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h5 class="fw-bold text-muted mb-3">üìç –°–∫–ª–∞–¥–∏ —Ç–∞ –û–±'—î–∫—Ç–∏</h5>
    
    {% if alerts %}
    <div class="alert alert-danger shadow-sm border-0 mb-4">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
            <div>
                <h6 class="alert-heading fw-bold mb-0">–ö—Ä–∏—Ç–∏—á–Ω—ñ –∑–∞–ª–∏—à–∫–∏!</h6>
                <ul class="mb-0 small ps-3">
                    {% for alert in alerts %}<li>{{ alert }}</li>{% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row g-3">
        {% for wh in warehouses %}
        <div class="col-md-6 col-lg-4">
            <a href="{% url 'warehouse_detail' wh.pk %}" class="text-decoration-none">
                <div class="card h-100 border-0 shadow-sm hover-shadow transition">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="fw-bold text-dark mb-0">{{ wh.name }}</h6>
                            <span class="badge bg-light text-dark border">{{ wh.total_value }} ‚Ç¥</span>
                        </div>
                        <p class="text-muted small mb-2 text-truncate"><i class="bi bi-geo-alt"></i> {{ wh.address|default:"–ë–µ–∑ –∞–¥—Ä–µ—Å–∏" }}</p>
                        <div class="d-flex align-items-center mt-3">
                            <div class="avatar bg-light text-secondary rounded-circle d-flex align-items-center justify-content-center me-2" style="width:32px; height:32px; font-size:0.8rem;">
                                {{ wh.responsible.username|slice:":1"|upper }}
                            </div>
                            <small class="text-muted">{{ wh.responsible.get_full_name|default:wh.responsible.username }}</small>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        {% endfor %}
    </div>
    {% endif %}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% if role == 'foreman' %}
<!-- –°–ö–ê–ù–ï–† –ë–Ü–ë–õ–Ü–û–¢–ï–ö–ê -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
    let html5QrcodeScanner = null;

    function startScanner() {
        document.getElementById('scanner-modal').style.display = 'flex';
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
            (decodedText) => {
                stopScanner();
                // –õ–æ–≥—ñ–∫–∞: –Ø–∫—â–æ —Ü–µ URL, –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –ø–æ –Ω—å–æ–º—É
                if (decodedText.startsWith("http")) {
                    if (confirm("–í—ñ–¥–∫—Ä–∏—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è: " + decodedText + "?")) {
                        window.location.href = decodedText;
                    }
                } else {
                    alert("–¶–µ –Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è: " + decodedText);
                }
            }
        ).catch(err => {
            alert("–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏: " + err); 
            stopScanner();
        });
    }

    function stopScanner() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.clear();
                document.getElementById('scanner-modal').style.display = 'none';
            });
        } else {
            document.getElementById('scanner-modal').style.display = 'none';
        }
    }
</script>
{% endif %}

{% if role != 'foreman' %}
<script id="chart-data-json" type="application/json">{{ chart_data|default:"[]"|safe }}</script>
<script id="chart-labels-json" type="application/json">{{ chart_labels|default:"[]"|safe }}</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('warehouseChart');
        let chartData = [], chartLabels = [];
        try {
            chartData = JSON.parse(document.getElementById('chart-data-json').textContent);
            chartLabels = JSON.parse(document.getElementById('chart-labels-json').textContent);
        } catch (e) {}

        if (ctx) {
            if (chartData.length > 0 && chartData.some(val => val > 0)) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: '–í–∞—Ä—Ç—ñ—Å—Ç—å (–≥—Ä–Ω)',
                            data: chartData,
                            backgroundColor: '#0d6efd',
                            borderRadius: 4,
                            barThickness: 30, 
                            maxBarThickness: 50
                        }]
                    },
                    options: { 
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { borderDash: [2, 4] } } }
                    }
                });
            } else {
                document.getElementById('noDataMessage').style.display = 'block';
            }
        }
    });
</script>
{% endif %}
{% endblock %}