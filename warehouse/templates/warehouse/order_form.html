{% extends 'warehouse/base.html' %}

{% block title %}–ù–æ–≤–∞ –∑–∞—è–≤–∫–∞{% endblock %}

{% block extra_css %}
<style>
    .item-row {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        transition: all 0.2s;
    }
    .item-row:hover {
        border-color: #adb5bd;
    }
    .btn-remove {
        color: #dc3545;
        cursor: pointer;
    }
    .btn-remove:hover {
        color: #a71d2a;
    }
    /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ñ–æ—Ç–æ */
    .file-upload-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        width: 100%;
    }
    .file-upload-wrapper input[type=file] {
        position: absolute;
        top: 0;
        right: 0;
        min-width: 100%;
        min-height: 100%;
        font-size: 100px;
        text-align: right;
        filter: alpha(opacity=0);
        opacity: 0;
        outline: none;
        background: white;
        cursor: inherit;
        display: block;
    }
    .file-upload-btn {
        border: 2px dashed #ced4da;
        background: #f8f9fa;
        color: #6c757d;
        padding: 15px;
        text-align: center;
        border-radius: 8px;
        width: 100%;
        transition: all 0.2s;
    }
    .file-upload-wrapper:hover .file-upload-btn {
        border-color: #0d6efd;
        color: #0d6efd;
        background: #f1f8ff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-3 pb-5" style="max-width: 800px;">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{% url 'index' %}" class="btn btn-light rounded-circle shadow-sm" style="width: 40px; height: 40px; display:flex; align-items:center; justify-content:center;">
            <i class="bi bi-x-lg"></i>
        </a>
        <h4 class="fw-bold mb-0">üìù –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É</h4>
        <div><!-- spacer --></div>
    </div>

    <form method="post" enctype="multipart/form-data" id="orderForm">
        {% csrf_token %}
        
        <!-- –ö–†–û–ö 1: –û–°–ù–û–í–ù–ê –Ü–ù–§–û–†–ú–ê–¶–Ü–Ø -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-white border-0 fw-bold pt-3">
                üìç –ö—É–¥–∏ —Ç–∞ –∫–æ–ª–∏?
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label small text-muted fw-bold">–û–±'—î–∫—Ç (–°–∫–ª–∞–¥)</label>
                        {{ form.warehouse }}
                        {% if form.warehouse.errors %}
                            <div class="text-danger small">{{ form.warehouse.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted fw-bold">–ù–∞ –¥–∞—Ç—É</label>
                        {{ form.expected_date }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted fw-bold">–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç</label>
                        {{ form.priority }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted fw-bold">–ó–∞–≥–∞–ª—å–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä</label>
                        {{ form.note }}
                    </div>
                    <!-- –§–æ—Ç–æ -->
                    <div class="col-12">
                        <label class="form-label small text-muted fw-bold">–§–æ—Ç–æ / –°—Ö–µ–º–∞ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                        <div class="file-upload-wrapper">
                            <div class="file-upload-btn" id="photo-placeholder">
                                <i class="bi bi-camera-fill fs-4 mb-2"></i><br>
                                –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± –¥–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ
                            </div>
                            {{ form.request_photo }}
                        </div>
                        <div id="file-name" class="small text-success mt-1" style="display:none;">
                            <i class="bi bi-check-lg"></i> –§–∞–π–ª –æ–±—Ä–∞–Ω–æ
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ö–†–û–ö 2: –°–ü–ò–°–û–ö –¢–û–í–ê–†–Ü–í -->
        <h5 class="fw-bold mb-3">üì¶ –°–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤</h5>
        
        <!-- MANAGEMENT FORM (–û–±–æ–≤'—è–∑–∫–æ–≤–æ!) -->
        {{ formset.management_form }}

        <div id="formset-container">
            {% for item_form in formset %}
                <div class="item-row row g-2 align-items-center">
                    <!-- –ü—Ä–∏—Ö–æ–≤–∞–Ω—ñ –ø–æ–ª—è ID (–¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è) -->
                    {% for hidden in item_form.hidden_fields %}
                        {{ hidden }}
                    {% endfor %}

                    <div class="col-7 col-md-8">
                        {% if forloop.first %}<label class="form-label small text-muted">–ú–∞—Ç–µ—Ä—ñ–∞–ª</label>{% endif %}
                        {{ item_form.material }}
                        {% if item_form.material.errors %}
                            <div class="text-danger small">{{ item_form.material.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-3 col-md-3">
                        {% if forloop.first %}<label class="form-label small text-muted">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</label>{% endif %}
                        {{ item_form.quantity }}
                        {% if item_form.quantity.errors %}
                            <div class="text-danger small">{{ item_form.quantity.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-2 col-md-1 text-center">
                        {% if forloop.first %}<label class="form-label small text-muted">&nbsp;</label>{% endif %}
                        <!-- –Ø–∫—â–æ —Ñ–æ—Ä–º–∞ –¥–æ–∑–≤–æ–ª—è—î –≤–∏–¥–∞–ª–µ–Ω–Ω—è -->
                        {% if formset.can_delete %}
                            <div class="d-none">{{ item_form.DELETE }}</div>
                            <i class="bi bi-trash3 btn-remove fs-5 mt-2 d-block" onclick="removeRow(this)"></i>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <button type="button" id="add-item-btn" class="btn btn-outline-primary w-100 py-2 border-dashed mt-2">
            <i class="bi bi-plus-lg me-1"></i> –î–æ–¥–∞—Ç–∏ —Ä—è–¥–æ–∫
        </button>

        <!-- –ü–£–°–¢–ò–ô –®–ê–ë–õ–û–ù –î–õ–Ø JS -->
        <div id="empty-form-template" style="display:none;">
            <div class="item-row row g-2 align-items-center">
                <div class="col-7 col-md-8">
                    {{ formset.empty_form.material }}
                </div>
                <div class="col-3 col-md-3">
                    {{ formset.empty_form.quantity }}
                </div>
                <div class="col-2 col-md-1 text-center">
                    <i class="bi bi-trash3 btn-remove fs-5" onclick="removeRow(this)"></i>
                </div>
            </div>
        </div>

        <!-- –ö–ù–û–ü–ö–ò –î–Ü–ô -->
        <div class="fixed-bottom bg-white border-top p-3 shadow-lg">
            <div class="container d-flex gap-2" style="max-width: 800px;">
                <button type="submit" name="action" value="draft" class="btn btn-light border flex-grow-1 fw-bold">
                    <i class="bi bi-save me-1"></i> –ß–µ—Ä–Ω–µ—Ç–∫–∞
                </button>
                <button type="submit" name="action" value="send" class="btn btn-primary flex-grow-1 fw-bold">
                    –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ <i class="bi bi-send-fill ms-1"></i>
                </button>
            </div>
        </div>

    </form>
</div>

<!-- Extra padding for fixed bottom -->
<div style="height: 80px;"></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('formset-container');
        const addBtn = document.getElementById('add-item-btn');
        const totalForms = document.getElementById('id_items-TOTAL_FORMS');
        const emptyTemplate = document.getElementById('empty-form-template').innerHTML;

        // 1. –î–æ–¥–∞–≤–∞–Ω–Ω—è —Ä—è–¥–∫–∞
        addBtn.addEventListener('click', function() {
            const formIdx = totalForms.value;
            // –ó–∞–º—ñ–Ω—é—î–º–æ __prefix__ –Ω–∞ –ø–æ—Ç–æ—á–Ω–∏–π —ñ–Ω–¥–µ–∫—Å (0, 1, 2...)
            const newRow = emptyTemplate.replace(/__prefix__/g, formIdx);
            
            container.insertAdjacentHTML('beforeend', newRow);
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ —Ñ–æ—Ä–º
            totalForms.value = parseInt(formIdx) + 1;
            
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ TomSelect –¥–ª—è –Ω–æ–≤–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞ (—è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è)
            // initTomSelects(); 
        });

        // 2. –û–±—Ä–æ–±–∫–∞ —Ñ–æ—Ç–æ input
        const photoInput = document.getElementById('id_request_photo');
        if(photoInput) {
            photoInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    document.getElementById('photo-placeholder').style.borderColor = '#198754';
                    document.getElementById('photo-placeholder').style.color = '#198754';
                    document.getElementById('photo-placeholder').style.backgroundColor = '#d1e7dd';
                    document.getElementById('photo-placeholder').innerHTML = '<i class="bi bi-check-lg fs-1"></i>';
                    
                    const fileName = document.getElementById('file-name');
                    fileName.innerHTML = '<i class="bi bi-check-lg"></i> ' + this.files[0].name;
                    fileName.style.display = 'block';
                }
            });
        }
    });

    // 3. –í–∏–¥–∞–ª–µ–Ω–Ω—è —Ä—è–¥–∫–∞
    function removeRow(btn) {
        const row = btn.closest('.item-row');
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Ü–µ —ñ—Å–Ω—É—é—á–∏–π –æ–±'—î–∫—Ç (—î –ø—Ä–∏—Ö–æ–≤–∞–Ω–µ –ø–æ–ª–µ id)
        const idField = row.querySelector('input[type="hidden"][name$="-id"]');
        
        if (idField && idField.value) {
            // –¶–µ —ñ—Å–Ω—É—é—á–∏–π –∑–∞–ø–∏—Å: —Ö–æ–≤–∞—î–º–æ —Ä—è–¥–æ–∫ —ñ —Å—Ç–∞–≤–∏–º–æ —á–µ–∫–±–æ–∫—Å DELETE = checked
            row.style.display = 'none';
            const deleteInput = row.querySelector('input[name$="-DELETE"]');
            if (deleteInput) deleteInput.checked = true;
        } else {
            // –¶–µ –Ω–æ–≤–∏–π –¥–∏–Ω–∞–º—ñ—á–Ω–∏–π —Ä—è–¥–æ–∫: –ø—Ä–æ—Å—Ç–æ –≤–∏–¥–∞–ª—è—î–º–æ –∑ DOM
            row.remove();
            // (–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ) –ú–æ–∂–Ω–∞ –∑–º–µ–Ω—à–∏—Ç–∏ TOTAL_FORMS, –∞–ª–µ Django –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–ø—É—Å–∫–∏
        }
    }
</script>
{% endblock %}