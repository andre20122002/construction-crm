{% extends 'warehouse/base.html' %}

{% block title %}–ó–≤—ñ—Ç –ø—Ä–æ —Å–ø–∏—Å–∞–Ω–Ω—è{% endblock %}

{% block content %}
<div class="container-fluid">
    <h3 class="mb-4 fw-bold"><i class="bi bi-trash3 me-2"></i> –°–ø–∏—Å–∞–Ω–Ω—è –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤</h3>

    <!-- –ê–ù–ê–õ–Ü–¢–ò–ß–ù–Ü –ö–ê–†–¢–ö–ò -->
    <div class="row g-3 mb-4 no-print">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm border-start border-4 border-warning h-100">
                <div class="card-body">
                    <div class="text-muted small text-uppercase fw-bold">–í–∏—Ç—Ä–∞—á–µ–Ω–æ –Ω–∞ —Ä–æ–±–æ—Ç–∏</div>
                    <div class="fs-3 fw-bold text-dark">{{ stats.work_sum|floatformat:2 }} ‚Ç¥</div>
                    <small class="text-muted"><i class="bi bi-hammer"></i> –ë—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–æ</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm border-start border-4 border-danger h-100">
                <div class="card-body">
                    <div class="text-muted small text-uppercase fw-bold">–í—Ç—Ä–∞—Ç–∏ / –ë—ñ–π</div>
                    <div class="fs-3 fw-bold text-danger">{{ stats.loss_sum|floatformat:2 }} ‚Ç¥</div>
                    <small class="text-danger"><i class="bi bi-x-circle"></i> –ù–µ–≤–∏—Ä–æ–±–Ω–∏—á—ñ –≤–∏—Ç—Ä–∞—Ç–∏</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm bg-secondary text-white h-100">
                <div class="card-body">
                    <div class="opacity-75 small text-uppercase fw-bold">–ó–∞–≥–∞–ª–æ–º —Å–ø–∏—Å–∞–Ω–æ</div>
                    <div class="fs-3 fw-bold">{{ stats.total_sum|floatformat:2 }} ‚Ç¥</div>
                    <small class="opacity-75">–ó–∞ –æ–±—Ä–∞–Ω–∏–π –ø–µ—Ä—ñ–æ–¥</small>
                </div>
            </div>
        </div>
    </div>

    <!-- –§–Ü–õ–¨–¢–†–ò -->
    <div class="card shadow-sm mb-4 border-0 bg-light no-print">
        <div class="card-body py-3">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-6 col-md-2">
                    <label class="small fw-bold text-muted">–ü–µ—Ä—ñ–æ–¥ –∑</label>
                    <input type="date" name="date_from" class="form-control form-control-sm" value="{{ f_date_from|default:'' }}">
                </div>
                <div class="col-6 col-md-2">
                    <label class="small fw-bold text-muted">–ø–æ</label>
                    <input type="date" name="date_to" class="form-control form-control-sm" value="{{ f_date_to|default:'' }}">
                </div>
                <div class="col-12 col-md-2">
                    <label class="small fw-bold text-muted">–ü—Ä–∏—á–∏–Ω–∞</label>
                    <select name="reason" class="form-select form-select-sm">
                        <option value="">–í—Å—ñ —Ç–∏–ø–∏</option>
                        <option value="OUT" {% if f_reason == 'OUT' %}selected{% endif %}>üõ†Ô∏è –†–æ–±–æ—Ç–∏</option>
                        <option value="LOSS" {% if f_reason == 'LOSS' %}selected{% endif %}>üóëÔ∏è –ë—ñ–π/–í—Ç—Ä–∞—Ç–∞</option>
                    </select>
                </div>
                <div class="col-12 col-md-2">
                    <label class="small fw-bold text-muted">–û–±'—î–∫—Ç</label>
                    <select name="warehouse" class="form-select form-select-sm">
                        <option value="">–í—Å—ñ –æ–±'—î–∫—Ç–∏</option>
                        {% for w in warehouses %}
                            <option value="{{ w.id }}" {% if f_wh == w.id %}selected{% endif %}>{{ w.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 col-md-2">
                    <label class="small fw-bold text-muted">–ú–∞—Ç–µ—Ä—ñ–∞–ª</label>
                    <select name="material" class="form-select form-select-sm">
                        <option value="">–í—Å—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏</option>
                        {% for m in materials %}
                            <option value="{{ m.id }}" {% if f_mat == m.id %}selected{% endif %}>{{ m.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 col-md-2 d-flex gap-1">
                    <button type="submit" class="btn btn-primary btn-sm w-100"><i class="bi bi-funnel"></i></button>
                    <button type="submit" name="export" value="excel" class="btn btn-success btn-sm w-100"><i class="bi bi-file-excel"></i></button>
                    <a href="{% url 'writeoff_report' %}" class="btn btn-outline-secondary btn-sm w-100"><i class="bi bi-x-lg"></i></a>
                </div>
            </form>
        </div>
    </div>

    <!-- –¢–ê–ë–õ–ò–¶–Ø -->
    <div class="card shadow-sm border-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 text-nowrap" style="font-size: 0.9rem;">
                <thead class="table-dark">
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–û–±'—î–∫—Ç</th>
                        <th>–ú–∞—Ç–µ—Ä—ñ–∞–ª</th>
                        <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                        <th>–¢–∏–ø</th>
                        <th>–•—Ç–æ —Å–ø–∏—Å–∞–≤</th>
                        <th>–ü—Ä–∏—á–∏–Ω–∞ / –ö–æ–º–µ–Ω—Ç–∞—Ä</th>
                        <th class="text-center">–§–æ—Ç–æ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in report_data %}
                    <tr>
                        <td>{{ row.date|date:"d.m.y H:i" }}</td>
                        <td class="fw-bold">{{ row.warehouse }}</td>
                        <td>
                            {{ row.material }}
                            <div class="text-muted small">
                                –°—É–º–∞: {{ row.sum }} ‚Ç¥
                            </div>
                        </td>
                        <td>
                            <span class="fs-6 fw-bold">{{ row.quantity }}</span> <small class="text-muted">{{ row.unit }}</small>
                        </td>
                        <td>
                            <!-- –í–ò–ü–†–ê–í–õ–ï–ù–ê –õ–û–ì–Ü–ö–ê –ë–ï–ô–î–ñ–Ü–í -->
                            {% if row.type_code == 'OUT' %}
                                <span class="badge bg-warning text-dark border border-warning bg-opacity-25">–†–æ–±–æ—Ç–∏</span>
                            {% elif row.type_code == 'LOSS' %}
                                <span class="badge bg-danger text-white">–í—Ç—Ä–∞—Ç–∞</span>
                            {% elif row.type_code == 'TRANSFER' %}
                                <span class="badge bg-info text-dark">–ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ row.type_display }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person-circle text-secondary me-2"></i>
                                {{ row.author }}
                            </div>
                        </td>
                        <td class="text-wrap" style="min-width: 200px; max-width: 300px;">
                            {{ row.reason }}
                        </td>
                        <td class="text-center">
                            {% if row.photo %}
                                <a href="{{ row.photo }}" target="_blank" class="btn btn-sm btn-outline-primary" title="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Ñ–æ—Ç–æ">
                                    <i class="bi bi-image"></i>
                                </a>
                            {% else %}
                                <span class="text-muted small">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-5 text-muted">
                            –°–ø–∏—Å–∞–Ω—å –∑–∞ –æ–±—Ä–∞–Ω–∏–º–∏ –∫—Ä–∏—Ç–µ—Ä—ñ—è–º–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}