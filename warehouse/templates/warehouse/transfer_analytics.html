{% extends 'warehouse/base.html' %}

{% block title %}–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –ª–æ–≥—ñ—Å—Ç–∏–∫–∏{% endblock %}

{% block content %}
<div class="container-fluid">
    <h3 class="mb-4 fw-bold"><i class="bi bi-graph-up-arrow me-2"></i> –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –ø–µ—Ä–µ–º—ñ—â–µ–Ω—å</h3>

    <!-- –§–Ü–õ–¨–¢–†–ò -->
    <form method="get" class="card shadow-sm mb-4 border-0 bg-light no-print">
        <div class="card-body row g-2 align-items-end">
            <div class="col-md-3">
                <label class="small fw-bold text-muted">–ü–µ—Ä—ñ–æ–¥ –∑</label>
                <input type="date" name="date_from" class="form-control" value="{{ date_from|default:'' }}">
            </div>
            <div class="col-md-3">
                <label class="small fw-bold text-muted">–ø–æ</label>
                <input type="date" name="date_to" class="form-control" value="{{ date_to|default:'' }}">
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-arrow-repeat"></i> –û–Ω–æ–≤–∏—Ç–∏</button>
            </div>
        </div>
    </form>

    <!-- KPI –ö–ê–†–¢–ö–ò -->
    <div class="row g-3 mb-4">
        <!-- –í—Å—å–æ–≥–æ –ø–µ—Ä–µ–º—ñ—â–µ–Ω—å -->
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100 bg-primary text-white">
                <div class="card-body d-flex align-items-center">
                    <div class="rounded-circle bg-white bg-opacity-25 p-3 me-3">
                        <i class="bi bi-truck fs-3"></i>
                    </div>
                    <div>
                        <div class="h2 fw-bold mb-0">{{ total_moves }}</div>
                        <div class="opacity-75 small">–í—Å—å–æ–≥–æ —Ä–µ–π—Å—ñ–≤ –∑–∞ –ø–µ—Ä—ñ–æ–¥</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å -->
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100 bg-info text-white">
                <div class="card-body d-flex align-items-center">
                    <div class="rounded-circle bg-white bg-opacity-25 p-3 me-3">
                        <i class="bi bi-stopwatch fs-3"></i>
                    </div>
                    <div>
                        <div class="h2 fw-bold mb-0">{{ avg_hours }} <small class="fs-6">–≥–æ–¥.</small></div>
                        <div class="opacity-75 small">–°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å –¥–æ—Å—Ç–∞–≤–∫–∏</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–æ–±–ª–µ–º–∏ (–í—Ç—Ä–∞—Ç–∏) -->
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100 {% if loss_cases > 0 %}bg-danger{% else %}bg-success{% endif %} text-white">
                <div class="card-body d-flex align-items-center">
                    <div class="rounded-circle bg-white bg-opacity-25 p-3 me-3">
                        <i class="bi bi-exclamation-triangle fs-3"></i>
                    </div>
                    <div>
                        <div class="h2 fw-bold mb-0">{{ loss_cases }}</div>
                        <div class="opacity-75 small">–í–∏–ø–∞–¥–∫—ñ–≤ –Ω–µ—Å—Ç–∞—á—ñ/–≤—Ç—Ä–∞—Ç</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ì–†–ê–§–Ü–ö–ò -->
    <div class="row g-4 mb-4">
        <!-- –¢–û–ü –ú–ê–¢–ï–†–Ü–ê–õ–Ü–í -->
        <div class="col-lg-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-white fw-bold border-0">
                    üì¶ –ù–∞–π—á–∞—Å—Ç—ñ—à–µ –ø–µ—Ä–µ–º—ñ—â—É–≤–∞–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏
                </div>
                <div class="card-body">
                    <canvas id="matChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <!-- –¢–û–ü –ú–ê–†–®–†–£–¢–Ü–í -->
        <div class="col-lg-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-white fw-bold border-0">
                    üõ£Ô∏è –ù–∞–π–±—ñ–ª—å—à –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ –º–∞—Ä—à—Ä—É—Ç–∏
                </div>
                <div class="card-body">
                    <canvas id="routeChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- –î–ï–¢–ê–õ–¨–ù–ê –¢–ê–ë–õ–ò–¶–Ø –ú–ê–†–®–†–£–¢–Ü–í -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 fw-bold">
            –î–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ –Ω–∞–ø—Ä—è–º–∫–∞—Ö
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>–ú–∞—Ä—à—Ä—É—Ç (–ó–≤—ñ–¥–∫–∏ -> –ö—É–¥–∏)</th>
                        <th class="text-center">–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–π—Å—ñ–≤</th>
                        <th class="text-end">–ß–∞—Å—Ç–∫–∞ (%)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for route in routes %}
                    <tr>
                        <td>
                            <i class="bi bi-geo-alt text-secondary"></i> {{ route.source_warehouse__name }} 
                            <i class="bi bi-arrow-right mx-2 text-primary"></i> 
                            {{ route.warehouse__name }}
                        </td>
                        <td class="text-center fw-bold">{{ route.trips }}</td>
                        <td class="text-end">
                            <!-- –ü—Ä–æ—Å—Ç–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤—ñ–¥—Å–æ—Ç–∫–∞ —É —à–∞–±–ª–æ–Ω—ñ -->
                            {% widthratio route.trips total_moves 100 %}%
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-center text-muted p-3">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- –î–ê–ù–Ü –î–õ–Ø JS -->
<script id="mat-labels" type="application/json">{{ mat_labels|safe }}</script>
<script id="mat-data" type="application/json">{{ mat_data|safe }}</script>
<script id="route-labels" type="application/json">{{ route_labels|safe }}</script>
<script id="route-data" type="application/json">{{ route_data|safe }}</script>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        function getData(id) { return JSON.parse(document.getElementById(id).textContent); }

        // 1. –ú–ê–¢–ï–†–Ü–ê–õ–ò (Pie Chart)
        new Chart(document.getElementById('matChart'), {
            type: 'pie',
            data: {
                labels: getData('mat-labels'),
                datasets: [{
                    data: getData('mat-data'),
                    backgroundColor: ['#0d6efd', '#20c997', '#ffc107', '#dc3545', '#6f42c1'],
                    borderWidth: 1
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { legend: { position: 'right' } } 
            }
        });

        // 2. –ú–ê–†–®–†–£–¢–ò (Horizontal Bar)
        new Chart(document.getElementById('routeChart'), {
            type: 'bar',
            data: {
                labels: getData('route-labels'),
                datasets: [{
                    label: '–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–π—Å—ñ–≤',
                    data: getData('route-data'),
                    backgroundColor: '#0dcaf0',
                    borderRadius: 5
                }]
            },
            options: { 
                indexAxis: 'y', // –†–æ–±–∏—Ç—å –≥—Ä–∞—Ñ—ñ–∫ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∏–º
                responsive: true, 
                maintainAspectRatio: false,
                scales: { x: { beginAtZero: true } }
            }
        });
    });
</script>
{% endblock %}