{% extends 'warehouse/base.html' %}

{% block title %}–õ–æ–≥—ñ—Å—Ç–∏–∫–∞ - –ë—É–¥–°–∫–ª–∞–¥{% endblock %}

{% block content %}
<div class="container-fluid">
    <h3 class="h4 mb-4">üöö –õ–æ–≥—ñ—Å—Ç–∏—á–Ω–∏–π –º–æ–Ω—ñ—Ç–æ—Ä</h3>

    <div class="row g-4">
        
        <!-- –ö–û–õ–û–ù–ö–ê 1: –£ –ó–ê–ö–£–ü–Ü–í–õ–Ü (Purchasing) -->
        <!-- –¢—É—Ç –∑–Ω–∞—Ö–æ–¥—è—Ç—å—Å—è –∑–∞—è–≤–∫–∏, —è–∫—ñ –≤–∂–µ –æ–ø–ª–∞—á–µ–Ω—ñ/–∑–∞–º–æ–≤–ª–µ–Ω—ñ, –∞–ª–µ —â–µ –Ω–µ –≤–∏—ó—Ö–∞–ª–∏ -->
        <div class="col-md-6">
            <div class="card h-100 border-0 shadow-sm bg-light">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold text-warning mb-0"><i class="bi bi-cart"></i> –£ –∑–∞–∫—É–ø—ñ–≤–ª—ñ</h5>
                    <span class="badge bg-warning text-dark rounded-pill">{{ purchasing_orders.count }}</span>
                </div>
                <div class="card-body">
                    {% for order in purchasing_orders %}
                    <div class="card mb-3 border-0 shadow-sm border-start border-4 border-warning">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between">
                                <h6 class="fw-bold mb-1">–ó–∞—è–≤–∫–∞ #{{ order.id }}</h6>
                                <small class="text-muted">{{ order.created_at|date:"d.m" }}</small>
                            </div>
                            
                            <!-- –°–ø–∏—Å–æ–∫ –ø–æ–∑–∏—Ü—ñ–π (–∫–æ—Ä–æ—Ç–∫–∏–π) -->
                            <div class="text-dark small mb-3 mt-2">
                                <ul class="list-unstyled mb-1 ps-2 border-start border-2">
                                    {% for item in order.items.all|slice:":3" %}
                                        <li>{{ item.material.name }} <span class="fw-bold text-muted">‚Äî {{ item.quantity }} {{ item.material.unit }}</span></li>
                                    {% empty %}
                                        <li class="text-muted">–ü–æ–∑–∏—Ü—ñ—ó –Ω–µ –≤–∫–∞–∑–∞–Ω—ñ</li>
                                    {% endfor %}
                                </ul>
                                {% if order.items.count > 3 %}
                                    <small class="text-muted ps-2">+ —â–µ {{ order.items.count|add:"-3" }} –ø–æ–∑.</small>
                                {% endif %}
                                <div class="mt-2 text-muted small">
                                    ‚ûî {{ order.warehouse.name }}
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="badge bg-white text-dark border text-truncate" style="max-width: 150px;">
                                    <i class="bi bi-shop"></i> 
                                    {% if order.selected_supplier %}
                                        {{ order.selected_supplier.name }}
                                    {% else %}
                                        {{ order.supplier_info|default:"–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫ –Ω–µ –≤–∫–∞–∑–∞–Ω–∏–π" }}
                                    {% endif %}
                                </div>
                                
                                <!-- –ö–ù–û–ü–ö–ê –í–Ü–î–ü–†–ê–í–ö–ò (–ó –º–æ–¥–∞–ª–∫–æ—é) -->
                                <button type="button" class="btn btn-sm btn-primary fw-bold" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#shipModal" 
                                        onclick="setShipOrder('{{ order.id }}', '–ó–∞—è–≤–∫–∞ #{{ order.id }}')">
                                    <i class="bi bi-truck"></i> –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏
                                </button>
                            </div>
                            
                            <div class="mt-2 text-end">
                                <small class="text-muted fst-italic">–û—á—ñ–∫—É—î: {{ order.created_by.get_full_name|default:order.created_by.username }}</small>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5 text-muted opacity-50">
                        <i class="bi bi-cart-x fs-1"></i>
                        <p class="small mt-2">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–∫—É–ø—ñ–≤–µ–ª—å</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- –ö–û–õ–û–ù–ö–ê 2: –í –î–û–†–û–ó–Ü (In Transit) -->
        <!-- –¢—É—Ç –∑–∞—è–≤–∫–∏, —è–∫—ñ –≤–∂–µ —ó–¥—É—Ç—å –Ω–∞ –æ–±'—î–∫—Ç -->
        <div class="col-md-6">
            <div class="card h-100 border-0 shadow-sm bg-light">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold text-info mb-0"><i class="bi bi-truck"></i> –í –¥–æ—Ä–æ–∑—ñ</h5>
                    <span class="badge bg-info text-dark rounded-pill">{{ transit_orders.count }}</span>
                </div>
                <div class="card-body">
                    {% for order in transit_orders %}
                    <div class="card mb-3 border-start border-4 border-info shadow-sm">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="fw-bold mb-1">–ó–∞—è–≤–∫–∞ #{{ order.id }}</h6>
                                    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–∑–∏—Ü—ñ–π -->
                                    <div class="small mt-1">
                                        {% for item in order.items.all|slice:":3" %}
                                            <div class="text-truncate" style="max-width: 200px;">
                                                ‚Ä¢ {{ item.material.name }} <b>({{ item.quantity }} {{ item.material.unit }})</b>
                                            </div>
                                        {% endfor %}
                                        {% if order.items.count > 3 %}
                                            <div class="text-muted small">+ —â–µ {{ order.items.count|add:"-3" }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <!-- –ö–Ω–æ–ø–∫–∞ –¥—Ä—É–∫—É –¢–¢–ù -->
                                <a href="{% url 'print_order_pdf' order.id %}" target="_blank" class="btn btn-sm btn-outline-secondary" title="–¢–¢–ù / –ù–∞–∫–ª–∞–¥–Ω–∞">
                                    <i class="bi bi-file-earmark-text"></i> –¢–¢–ù
                                </a>
                            </div>
                            
                            <!-- –Ü–Ω—Ñ–æ –ø—Ä–æ –º–∞—à–∏–Ω—É -->
                            {% if order.vehicle_number or order.driver_name %}
                            <div class="mt-2 mb-2 p-2 bg-info bg-opacity-10 rounded border border-info border-opacity-25 small">
                                <i class="bi bi-truck-front-fill me-2"></i> 
                                <b>{{ order.vehicle_number }}</b> 
                                <span class="text-muted">({{ order.driver_name }})</span>
                            </div>
                            {% endif %}
                            
                            <div class="d-flex align-items-center mt-3 small text-muted bg-light p-2 rounded">
                                <div class="me-2 text-truncate" style="max-width: 45%;">
                                    {% if order.source_warehouse %}
                                        <i class="bi bi-building"></i> {{ order.source_warehouse.name }}
                                    {% else %}
                                        <i class="bi bi-shop"></i> 
                                        {% if order.selected_supplier %}
                                            {{ order.selected_supplier.name }}
                                        {% else %}
                                            {{ order.supplier_info|default:"–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫..." }}
                                        {% endif %}
                                    {% endif %}
                                </div>
                                <i class="bi bi-arrow-right mx-2 text-primary"></i>
                                <div class="fw-bold text-dark text-truncate" style="max-width: 45%;">
                                    <i class="bi bi-geo-alt-fill"></i> {{ order.warehouse.name }}
                                </div>
                            </div>
                            
                            <div class="mt-2 text-end">
                                <small class="text-muted fst-italic">–û—á—ñ–∫—É—î: {{ order.created_by.get_full_name|default:order.created_by.username }}</small>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5 text-muted opacity-50">
                        <i class="bi bi-truck fs-1"></i>
                        <p class="small mt-2">–í—Å—ñ –º–∞—à–∏–Ω–∏ –ø—Ä–∏—ó—Ö–∞–ª–∏</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

    </div>
</div>

<!-- –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û –í–Ü–î–ü–†–ê–í–ö–ò -->
<div class="modal fade" id="shipModal" tabindex="-1">
    <div class="modal-dialog">
        <form method="post" enctype="multipart/form-data" id="shipForm" class="modal-content">
            {% csrf_token %}
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">üöõ –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤–∞–Ω—Ç–∞–∂—É</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">–í–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç–µ: <b id="shipOrderName" class="text-dark">...</b></p>
                
                <h6 class="fw-bold mb-3 text-primary">–î–∞–Ω—ñ –ª–æ–≥—ñ—Å—Ç–∏–∫–∏ (–ù–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</h6>
                <div class="mb-3">
                    <label class="form-label small fw-bold">–í–æ–¥—ñ–π (–ü–Ü–ë)</label>
                    <input type="text" name="driver_name" class="form-control" placeholder="–ù–∞–ø—Ä: –Ü–≤–∞–Ω–æ–≤ –Ü–≤–∞–Ω">
                </div>
                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="form-label small fw-bold">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="text" name="driver_phone" class="form-control" placeholder="050...">
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label small fw-bold">–ù–æ–º–µ—Ä –∞–≤—Ç–æ</label>
                        <input type="text" name="vehicle_number" class="form-control" placeholder="–ê–ê 1234 –í–í">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">–§–æ—Ç–æ –¢–¢–ù / –ù–∞–∫–ª–∞–¥–Ω–æ—ó</label>
                    <input type="file" name="shipping_doc" class="form-control">
                    <div class="form-text">–°–∫–∞–Ω –Ω–∞–∫–ª–∞–¥–Ω–æ—ó, —è–∫–∏–π –ø–æ–±–∞—á–∏—Ç—å –ø—Ä–æ—Ä–∞–± –ø—Ä–∏ –ø—Ä–∏–π–æ–º—ñ.</div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button type="submit" class="btn btn-primary fw-bold px-4">
                    <i class="bi bi-send-check me-2"></i> –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –≤—ñ–¥–ø—Ä–∞–≤–∫—É
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function setShipOrder(id, name) {
        // –§–æ—Ä–º—É—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π URL –¥–ª—è POST –∑–∞–ø–∏—Ç—É. –£ urls.py: path('order/<int:pk>/mark_shipped/', ...)
        document.getElementById('shipForm').action = "/order/" + id + "/mark_shipped/";
        document.getElementById('shipOrderName').innerText = name;
    }
</script>
{% endblock %}